<!DOCTYPE html>
<html lang="en">
<head>
    </script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    {% set resolved_meta_description = meta_description|default('Get the ultimate market sentiment and stock sentiment analysis using AI to get live data and news analysis that help make stock predictions and stock forecasts.', true) %}
    <meta name="description" content="{{ resolved_meta_description }}">
    <meta name="msvalidate.01" content="3EEDAE9565183A466E75364048FC8D47" />
    <meta name="google-site-verification" content="2SD21a9x2-kiPIB6JKVUg27gcu1GmmocLo8KfoDMadI" />
    {% set resolved_page_title = market_summary_page_title|default('Stock Sentiment Analysis', true) %}
    <title>{{ resolved_page_title }}</title>
    {% if market_summary_canonical_url is defined and market_summary_canonical_url %}
    <link rel="canonical" href="{{ market_summary_canonical_url }}">
    {% elif market_summary_slug is defined and market_summary_slug %}
    <link rel="canonical" href="{{ url_for('market_summary_article_page', summary_slug=market_summary_slug, _external=True) }}">
    {% endif %}
    <script defer src="https://cloud.umami.is/script.js" data-website-id="078f3d2c-6b5f-470f-8a31-50607dd5f0cd"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="icon" type="image/x-icon" href="{{ url_for('static', filename='favicon.ico') }}">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-3743637326749752"
     crossorigin="anonymous"></script>
    </script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background-color: #000000;
            color: #ffffff;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .search-section {
            margin-bottom: 40px;
        }

        .page-title-row {
            display: flex;
            align-items: center;
            gap: 18px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .nav-button-row {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .nav-pill-btn {
            background: #18181b;
            color: #b48be4;
            font-weight: 500;
            font-size: 15px;
            padding: 7px 18px;
            border: none;
            border-radius: 7px;
            cursor: pointer;
            transition: background 0.2s, color 0.2s;
            box-shadow: none;
        }

        .nav-pill-btn:hover {
            background: #232136;
            color: #c4b5fd;
        }

        .watchlist-page #watchlistNavBtn {
            background: #9333ea;
            color: #fff;
        }

        .trending-page #trendingBtn {
            background: #9333ea;
            color: #fff;
        }

        .market-page #marketSummaryBtn {
            background: #9333ea;
            color: #fff;
        }

        .watchlist-page #trendingSection {
            display: none;
        }

        .search-box {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        input[type="text"] {
            flex: 1;
            padding: 15px;
            background-color: #1a1a1a;
            border: 1px solid #333;
            border-radius: 8px;
            color: #ffffff;
            font-size: 16px;
        }

        input[type="text"]:focus {
            outline: none;
            border-color: #9333ea;
        }

        button {
            padding: 15px 30px;
            background-color: #9333ea;
            border: none;
            border-radius: 8px;
            color: white;
            font-size: 16px;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        button:hover {
            background-color: #7e22ce;
        }

        button:disabled {
            background-color: #555;
            cursor: not-allowed;
        }

        .loading {
            display: none;
            text-align: center;
            padding: 20px;
            color: #9333ea;
        }

        #errorMessage {
            margin-top: 10px;
        }

        .error-message {
            background: rgba(239, 68, 68, 0.12);
            border: 1px solid rgba(239, 68, 68, 0.35);
            color: #fecdd3;
            padding: 12px 14px;
            border-radius: 8px;
            font-weight: 600;
        }

        .retry-button {
            margin-top: 12px;
            display: block;
            width: fit-content;
            margin-left: auto;
            margin-right: auto;
        }

        @keyframes shimmer {
            0% {
                background-position: -200% 0;
            }
            100% {
                background-position: 200% 0;
            }
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }



        .stock-header {
            margin-bottom: 30px;
        }

        .company-header {
            display: flex;
            align-items: center;
            gap: 16px;
            flex-wrap: wrap;
        }

        .watchlist-toggle-btn {
            background-color: rgba(147, 51, 234, 0.15);
            border: 1px solid rgba(147, 51, 234, 0.4);
            color: #e9d5ff;
            padding: 10px 18px;
            font-size: 15px;
            border-radius: 999px;
            cursor: pointer;
            transition: background-color 0.2s, border-color 0.2s;
        }

        .watchlist-toggle-btn:hover {
            background-color: rgba(147, 51, 234, 0.3);
        }

        .watchlist-toggle-btn.saved {
            background-color: rgba(239, 68, 68, 0.2);
            border-color: rgba(239, 68, 68, 0.6);
            color: #fecaca;
        }

        .watchlist-toggle-btn.saved:hover {
            background-color: rgba(239, 68, 68, 0.35);
        }

        .company-name {
            font-size: 36px;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .stock-price {
            font-size: 48px;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .price-change {
            font-size: 18px;
            margin-bottom: 5px;
        }

        .positive {
            color: #33ea93;
        }

        .negative {
            color: #ef4444;
        }

        .chart-container {
            background-color: #0a0a0a;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 30px;
            height: 500px;
            position: relative;
            display: flex;
            flex-direction: column;
            width: 100%;
            max-width: 100%;
            overflow: hidden;
        }

        .chart-container canvas {
            flex: 1;
            position: relative;
            min-height: 0;
        }

        .movement-box {
            background-color: #11111a;
            border: 1px solid rgba(147, 51, 234, 0.2);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 30px;
        }

        .movement-title {
            font-size: 18px;
            font-weight: 600;
            color: #c4b5fd;
            margin-bottom: 10px;
        }

        .movement-summary {
            color: #e4e4e7;
            line-height: 1.5;
            margin-bottom: 16px;
        }

        .movement-meta {
            color: #a1a1aa;
            font-size: 13px;
            margin-bottom: 12px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .movement-sources {
            list-style: none;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .movement-sources li {
            font-size: 14px;
            color: #cbd5f5;
        }

        .movement-sources a {
            color: #8b5cf6;
            text-decoration: none;
        }

        .movement-sources a:hover {
            text-decoration: underline;
        }

        .chart-tabs {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
            padding-bottom: 20px;
            border-bottom: 1px solid #333;
            z-index: 2;
            position: relative;
            flex-wrap: nowrap;
            overflow-x: auto;
            scrollbar-width: none;
        }

        .chart-tabs::-webkit-scrollbar {
            display: none;
        }

        .chart-tab {
            color: #888;
            cursor: pointer;
            padding: 5px 10px;
            border-bottom: 2px solid transparent;
            white-space: nowrap;
        }

        .chart-tab.active {
            color: #9333ea;
            border-bottom-color: #9333ea;
        }

        .info-section {
            background-color: #0a0a0a;
            border-radius: 12px;
            padding: 30px;
            margin-bottom: 30px;
        }

        .section-title {
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid #333;
        }

        .about-text-wrapper {
            color: #ccc;
            line-height: 1.6;
            margin-bottom: 20px;
        }

        .about-text {
            display: inline;
        }

        #toggleAboutBtn {
            background: none;
            border: none;
            color: #9333ea;
            cursor: pointer;
            font-size: 14px;
            padding: 0;
            margin-left: 6px;
        }

        .company-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .detail-item {
            display: flex;
            flex-direction: column;
        }

        .detail-label {
            color: #888;
            font-size: 14px;
            margin-bottom: 5px;
        }

        .detail-value {
            font-size: 18px;
            font-weight: 500;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(4, minmax(0, 1fr));
            gap: 20px 40px;
            max-width: 900px;
            margin: 0 auto;
        }

        .stat-item {
            display: flex;
            flex-direction: column;
        }

        .stat-label {
            color: #888;
            font-size: 14px;
            margin-bottom: 5px;
        }

        .stat-value {
            font-size: 18px;
            font-weight: 500;
        }

        .news-section {
            margin-top: 30px;
        }

        .news-pending {
            padding: 18px;
            margin-bottom: 15px;
            border: 1px dashed #333;
            border-radius: 12px;
            text-align: center;
            color: #a1a1aa;
            font-size: 14px;
        }

        .sentiment-summary {
            display: flex;
            gap: 12px;
            margin-bottom: 20px;
            padding: 16px 18px;
            background-color: #0a0a0a;
            border-radius: 12px;
            flex-wrap: nowrap;
            overflow-x: auto;
            scrollbar-width: none;
            position: relative;
        }

        .sentiment-summary.is-loading {
            overflow: hidden;
        }

        .sentiment-summary.is-loading::after {
            content: '';
            position: absolute;
            inset: 0;
            background: linear-gradient(90deg, rgba(255, 255, 255, 0), rgba(255, 255, 255, 0.06), rgba(255, 255, 255, 0));
            background-size: 200% 100%;
            animation: shimmer 2.2s linear infinite;
            pointer-events: none;
            z-index: 0;
        }

        .sentiment-summary .sentiment-item,
        .sentiment-summary .sentiment-summary-spinner {
            position: relative;
            z-index: 1;
        }

        .sentiment-summary-spinner {
            width: 18px;
            height: 18px;
            border-radius: 50%;
            border: 2px solid #2f2f37;
            border-top-color: #c084fc;
            animation: spin 0.9s linear infinite;
            align-self: center;
            margin-left: auto;
            display: none;
            flex-shrink: 0;
        }

        .sentiment-summary.is-loading .sentiment-summary-spinner {
            display: inline-block;
        }

        .sentiment-summary::-webkit-scrollbar {
            display: none;
        }

        .sentiment-item {
            flex: 1;
            text-align: center;
            min-width: 95px;
        }

        .sentiment-label {
            color: #e6e6e6;
            font-size: 12px;
            margin-bottom: 4px;
            font-weight: 600;
        }

        .sentiment-value {
            font-size: 20px;
            font-weight: bold;
        }

        .news-article {
            background-color: #0a0a0a;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 15px;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        .news-article:hover {
            background-color: #1a1a1a;
        }

        .news-image-wrapper {
            border-radius: 10px;
            overflow: hidden;
            margin-bottom: 14px;
            background: #050505;
        }

        .news-image-wrapper img {
            width: 100%;
            display: block;
            object-fit: cover;
            max-height: 280px;
        }

        .unsplash-attribution {
            font-size: 11px;
            color: #a1a1aa;
            margin-top: 8px;
            display: flex;
            flex-wrap: wrap;
            gap: 4px;
        }

        .unsplash-attribution a {
            color: #c4b5fd;
            text-decoration: none;
        }

        .unsplash-attribution a:hover {
            text-decoration: underline;
        }

        .news-source {
            color: #888;
            font-size: 12px;
            margin-bottom: 5px;
        }

        .news-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 10px;
        }

        .news-description {
            color: #ccc;
            font-size: 14px;
            line-height: 1.6;
            margin-bottom: 10px;
        }

        .news-meta {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 12px;
            color: #888;
        }

        .sentiment-badge {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 4px 12px;
            border-radius: 12px;
            font-weight: 600;
            text-transform: uppercase;
            font-size: 11px;
        }

        .sentiment-badge.positive {
            background-color: rgba(51, 234, 147, 0.2);
            color: #33ea93;
        }

        .sentiment-badge.negative {
            background-color: rgba(239, 68, 68, 0.2);
            color: #ef4444;
        }

        .sentiment-badge.neutral {
            background-color: rgba(136, 136, 136, 0.2);
            color: #888;
        }

        .sentiment-badge.muted {
            opacity: 0.7;
        }

        .sentiment-status {
            color: #a1a1aa;
            font-size: 13px;
            margin-top: 8px;
            margin-bottom: 8px;
            display: none;
        }

        .sentiment-progress {
            width: 100%;
            height: 6px;
            border-radius: 999px;
            background: rgba(147, 51, 234, 0.18);
            overflow: hidden;
            margin: 4px 0 18px;
            opacity: 0;
            transition: opacity 0.25s ease;
        }

        .sentiment-progress.is-active {
            opacity: 1;
        }

        .sentiment-progress-bar {
            width: 0%;
            height: 100%;
            background: linear-gradient(90deg, #9333ea, #c084fc);
            border-radius: inherit;
            transition: width 0.25s ease;
        }

        .sentiment-badge.loading {
            position: relative;
            background-color: #1f1f1f;
            color: #a1a1aa;
            overflow: hidden;
        }

        .sentiment-badge.loading::after {
            content: '';
            position: absolute;
            inset: 0;
            background: linear-gradient(90deg, rgba(255, 255, 255, 0), rgba(255, 255, 255, 0.14), rgba(255, 255, 255, 0));
            background-size: 200% 100%;
            animation: shimmer 1.9s linear infinite;
        }

        #results {
            display: none;
        }

        .error-message {
            background-color: rgba(239, 68, 68, 0.2);
            border: 1px solid #ef4444;
            color: #ef4444;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .trending-section {
            background-color: #0a0a0a;
            border-radius: 12px;
            padding: 30px;
            margin-bottom: 40px;
        }
        .trending-columns {
            display: flex;
            width: 100%;
        }
        .trending-column {
            display: none;
            flex-direction: column;
            width: 100%;
            max-width: 100%;
        }
        .trending-column.active {
            display: flex;
        }
        .trending-column-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 16px;
            color: #c4b5fd;
        }
        .trending-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        .trending-item {
            background: #1a1a1a;
            border-radius: 10px;
            padding: 16px 20px;
            min-width: 180px;
            display: flex;
            flex-direction: row;
            align-items: center;
            gap: 16px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            transition: background 0.2s;
            cursor: pointer;
        }
        .trending-item:hover {
            background: #222;
        }
        .trending-card-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            min-width: 0;
            overflow: hidden;
        }
        .trending-card-aside {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 8px;
            min-width: 40px;
        }
        .trending-card-aside:empty {
            display: none;
        }
        .trending-rank {
            font-size: 22px;
            font-weight: 700;
            color: #888;
            margin-right: 18px;
            width: 32px;
            text-align: right;
        }
        .trending-ticker {
            font-size: 20px;
            font-weight: 700;
            color: #9333ea;
            margin-bottom: 2px;
        }
        .trending-ticker-row {
            display: flex;
            align-items: center;
            gap: 8px;
            flex-wrap: wrap;
            margin-bottom: 4px;
        }
        .trending-name {
            font-size: 15px;
            color: #fff;
            margin-bottom: 8px;
            display: -webkit-box;
            width: 100%;
            max-width: 100%;
            min-width: 0;
            overflow: hidden;
            text-overflow: ellipsis;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            white-space: normal;
            word-break: break-word;
        }
        .trending-info-btn {
            border: 1px solid rgba(196,181,253,0.4);
            background: rgba(147,51,234,0.15);
            color: #c4b5fd;
            width: 22px;
            height: 22px;
            min-width: 22px;
            min-height: 22px;
            padding: 0;
            border-radius: 50%;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.2s, color 0.2s, border-color 0.2s;
            flex-shrink: 0;
        }
        .trending-info-btn .icon {
            pointer-events: none;
        }
        .trending-info-btn:hover,
        .trending-info-btn:focus-visible {
            background: rgba(196,181,253,0.3);
            color: #fff;
            border-color: rgba(196,181,253,0.65);
            outline: none;
        }
        .trending-summary-popover {
            position: absolute;
            z-index: 30;
            width: min(320px, calc(100vw - 40px));
            background: #11111b;
            border: 1px solid rgba(196,181,253,0.4);
            border-radius: 10px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.35);
            padding: 14px 16px;
            display: none;
        }
        .trending-summary-popover.visible {
            display: block;
        }
        .trending-summary-popover::after {
            content: '';
            position: absolute;
            width: 12px;
            height: 12px;
            background: #11111b;
            border-left: 1px solid rgba(196,181,253,0.4);
            border-bottom: 1px solid rgba(196,181,253,0.4);
            transform: rotate(45deg);
            bottom: -6px;
            left: var(--popover-arrow-offset, 20px);
        }
        .trending-summary-popover-heading {
            font-size: 14px;
            font-weight: 600;
            color: #c4b5fd;
            margin-bottom: 6px;
        }
        .trending-summary-popover-body {
            font-size: 13px;
            color: #f3f4f6;
            line-height: 1.45;
            white-space: pre-line;
            margin-bottom: 8px;
        }
        .trending-summary-popover-meta {
            font-size: 12px;
            color: #9ca3af;
        }
        .trending-summary-popover.is-loading .trending-summary-popover-body {
            color: #9ca3af;
        }
        .trending-summary-popover.is-error {
            border-color: rgba(239,68,68,0.6);
        }
        .trending-pct {
            font-size: 14px;
            color: #33ea93;
            font-weight: 600;
        }
        .trending-pct.negative {
            color: #ef4444;
        }
        .trending-tag {
            background: rgba(51,234,147,0.12);
            color: #33ea93;
            font-size: 11px;
            font-weight: 700;
            border-radius: 8px;
            padding: 2px 10px;
            text-transform: uppercase;
        }

        .trending-change {
            font-size: 13px;
            font-weight: 600;
            padding: 2px 10px;
            border-radius: 8px;
            background: rgba(51, 234, 147, 0.12);
            color: #33ea93;
            text-transform: uppercase;
            letter-spacing: 0.3px;
        }

        .trending-change.negative {
            background: rgba(239, 68, 68, 0.15);
            color: #ef4444;
        }

        .trending-change.neutral {
            background: rgba(148, 163, 184, 0.18);
            color: #d1d5db;
            text-transform: none;
        }

        .trending-change-inline {
            display: none;
        }

        .trending-change-right {
            margin-left: auto;
            display: flex;
            align-items: center;
        }

        .trending-metrics-row {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 6px;
        }

        .trending-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .trending-tab-btn {
            flex: 1 1 200px;
            background: #18181b;
            border-radius: 8px;
            border: 1px solid #2f2f37;
            padding: 10px 14px;
            font-size: 14px;
            color: #cbd5f5;
            text-align: center;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .trending-tab-btn.active {
            background: #312e81;
            border-color: #6366f1;
            color: #fff;
        }

        .trending-message {
            color: #888;
            font-size: 14px;
            padding: 12px 0;
        }

        .watchlist-section {
            background-color: #0a0a0a;
            border-radius: 12px;
            padding: 30px;
            margin-bottom: 40px;
            border: 1px solid rgba(147, 51, 234, 0.15);
        }

        .watchlist-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .watchlist-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: #17171f;
            border: 1px solid #222032;
            border-radius: 10px;
            padding: 14px 18px;
            cursor: pointer;
            transition: border-color 0.2s, background 0.2s;
        }

        .watchlist-item:hover {
            border-color: #9333ea;
            background: #1f1b2e;
        }

        .watchlist-item-left {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .watchlist-symbol {
            font-size: 18px;
            font-weight: 600;
            color: #f3f4f6;
        }

        .watchlist-name {
            font-size: 14px;
            color: #a1a1aa;
        }

        .watchlist-meta {
            display: flex;
            align-items: center;
            gap: 12px;
            flex-wrap: wrap;
            justify-content: flex-end;
        }

        .watchlist-price {
            font-size: 16px;
            font-weight: 600;
            color: #e4e4e7;
        }

        .watchlist-updated {
            font-size: 12px;
            color: #888;
        }

        .watchlist-empty {
            color: #888;
            font-size: 14px;
            text-align: center;
            padding: 16px 0;
        }

        .watchlist-remove-btn {
            background: transparent;
            border: none;
            color: #888;
            font-size: 18px;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            cursor: pointer;
            transition: color 0.2s, background 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            line-height: 1;
            padding: 0;
            margin-left: 4px;
        }

        .watchlist-remove-btn:hover {
            color: #ef4444;
            background: rgba(239, 68, 68, 0.15);
        }

        .market-summary-section {
            background-color: #0a0a0a;
            border-radius: 12px;
            padding: 30px;
            margin-bottom: 40px;
            border: 1px solid rgba(147, 51, 234, 0.2);
        }

        .market-summary-signup {
            background: #11111a;
            border-radius: 12px;
            border: 1px solid rgba(147, 51, 234, 0.25);
            padding: 22px;
            margin-bottom: 30px;
            box-shadow: 0 12px 25px rgba(0,0,0,0.35);
        }

        .market-summary-signup h3 {
            margin: 0 0 6px;
            font-size: 18px;
        }

        .market-summary-signup p {
            margin: 0 0 18px;
            color: #a1a1aa;
            font-size: 14px;
        }

        .market-summary-signup form {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
        }

        .market-summary-signup input[type="email"] {
            flex: 1 1 220px;
            background: #0b0b12;
            border: 1px solid rgba(255,255,255,0.08);
            border-radius: 8px;
            padding: 12px 14px;
            color: #f9fafb;
            font-size: 15px;
        }

        .market-summary-signup input[type="email"]:focus {
            outline: none;
            border-color: #8b5cf6;
            box-shadow: 0 0 0 2px rgba(139,92,246,0.25);
        }

        .market-summary-signup button {
            flex: 0 0 auto;
            background: #7c3aed;
            border: none;
            border-radius: 8px;
            padding: 12px 20px;
            color: #fff;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.2s ease;
        }

        .market-summary-signup button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .market-summary-signup button:hover:not(:disabled) {
            background: #8b5cf6;
        }

        .market-summary-signup-status {
            margin-top: 14px;
            font-size: 14px;
            color: #cbd5f5;
            min-height: 18px;
        }

        .market-summary-signup-status.success {
            color: #33ea93;
        }

        .market-summary-signup-status.error {
            color: #f87171;
        }

        .market-summary-note {
            color: #a1a1aa;
            font-size: 14px;
            margin-bottom: 18px;
        }

        .market-summary-card {
            background: #11111a;
            border-radius: 12px;
            border: 1px solid rgba(147, 51, 234, 0.15);
            padding: 24px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.25);
        }

        .market-summary-hero {
            position: relative;
            border-radius: 12px;
            overflow: hidden;
            margin-bottom: 20px;
            border: 1px solid rgba(255,255,255,0.05);
            background: #050505;
        }

        .market-summary-hero img {
            width: 100%;
            height: 260px;
            object-fit: cover;
            display: block;
        }

        .market-summary-hero .unsplash-attribution {
            position: absolute;
            right: 12px;
            bottom: 12px;
            margin: 0;
            background: rgba(0, 0, 0, 0.65);
            padding: 6px 12px;
            border-radius: 999px;
        }

        .market-summary-title {
            font-size: 22px;
            font-weight: 600;
            margin-bottom: 6px;
        }

        .market-summary-meta {
            font-size: 13px;
            letter-spacing: 0.3px;
            text-transform: uppercase;
            color: #a1a1aa;
            margin-bottom: 16px;
        }

        .market-summary-body {
            color: #d1d5db;
            line-height: 1.7;
            margin-bottom: 18px;
        }

        .market-summary-body p + p {
            margin-top: 12px;
        }

        .market-summary-indices {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 16px;
            margin-bottom: 18px;
        }

        .market-index-item {
            background: #1c1b27;
            border-radius: 10px;
            padding: 14px;
            border: 1px solid rgba(99,102,241,0.25);
        }

        .market-index-label {
            font-size: 14px;
            color: #c4b5fd;
            margin-bottom: 6px;
        }

        .market-index-price {
            font-size: 20px;
            font-weight: 600;
        }

        .market-index-change {
            font-size: 14px;
            font-weight: 600;
        }

        .market-index-change.positive {
            color: #33ea93;
        }

        .market-index-change.negative {
            color: #ef4444;
        }

        .market-summary-headlines {
            background: #13131f;
            border-radius: 10px;
            padding: 18px;
            border: 1px solid rgba(147, 51, 234, 0.15);
        }

        .market-summary-headlines h3 {
            font-size: 15px;
            font-weight: 600;
            color: #c4b5fd;
            margin-bottom: 12px;
            text-transform: uppercase;
            letter-spacing: 0.3px;
        }

        .market-summary-headlines ul {
            list-style: none;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .market-summary-headlines li a {
            color: #e0e7ff;
            text-decoration: none;
        }

        .market-summary-headlines li a:hover {
            text-decoration: underline;
        }

        .market-summary-headlines li span {
            display: block;
            font-size: 12px;
            color: #9ca3af;
            margin-top: 2px;
        }

        .market-summary-share {
            margin-top: 14px;
            display: flex;
            justify-content: flex-start;
        }

        .market-summary-share a {
            color: #c4b5fd;
            font-weight: 600;
            text-decoration: none;
        }

        .market-summary-share a:hover {
            text-decoration: underline;
        }

        .market-summary-archive {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .market-summary-archive-item {
            border: 1px solid rgba(255,255,255,0.08);
            border-radius: 10px;
            padding: 14px 18px;
            background: #0f0f19;
        }

        .market-summary-archive-item summary {
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            list-style: none;
            font-weight: 600;
        }

        .market-summary-archive-item summary::-webkit-details-marker {
            display: none;
        }

        .market-summary-archive-item[open] summary {
            margin-bottom: 12px;
        }

        .market-summary-empty {
            color: #a1a1aa;
            padding: 18px;
            background: rgba(147,51,234,0.08);
            border-radius: 10px;
            border: 1px dashed rgba(147,51,234,0.4);
        }

        .market-summary-empty.error {
            background: rgba(239,68,68,0.15);
            border-color: rgba(239,68,68,0.5);
            color: #fecaca;
        }

        @media (min-width: 721px) {
            .trending-change-inline {
                display: none;
            }
        }

        @media (max-width: 720px) {
            .trending-item {
                flex-direction: column;
                align-items: flex-start;
            }

            .trending-change-inline {
                display: inline-flex;
            }

            .trending-change-right {
                display: none;
            }
        }

        @media (max-width: 900px) {
            .trending-columns {
                flex-direction: column;
            }

            .trending-tabs {
                display: flex;
            }

            .stats-grid {
                grid-template-columns: repeat(2, minmax(0, 1fr));
                max-width: 640px;
            }
        }

        #trendingBtn:hover {
            background: #232136;
            color: #c4b5fd;
        }

        @media (max-width: 640px) {
            body {
                padding: 16px;
            }

            .chart-container {
                padding: 16px;
                height: 320px;
            }

            .sentiment-summary {
                padding: 12px 14px;
                gap: 8px;
            }

            .sentiment-item {
                min-width: 85px;
            }

            .sentiment-label {
                font-size: 11px;
            }

            .sentiment-value {
                font-size: 18px;
            }
        }

    </style>
</head>
    {% set resolved_page = page_view or 'home' %}
    {% set body_class = resolved_page + '-page' %}
    <body class="{{ body_class }}" data-page="{{ resolved_page }}" data-search-query="{{ initial_query or '' }}" data-unsplash-ref="{{ unsplash_referral_url }}" data-market-article-slug="{{ market_summary_slug|default('', true) }}" data-trending-source="{{ trending_source|default('stocktwits', true) }}">
    <div class="container">
        <div class="search-section">
            <div class="page-title-row">
                <h1 style="font-size:32px;cursor:pointer;" id="homeTitle">Stock Sentiment Analysis</h1>
                <div class="nav-button-row">
                    <button id="trendingBtn" class="nav-pill-btn" type="button">Trending</button>
                    <button id="watchlistNavBtn" class="nav-pill-btn" type="button">Watchlist</button>
                    <button id="marketSummaryBtn" class="nav-pill-btn" type="button">Market Summary</button>
                </div>
            </div>
            <div class="search-box">
                <input type="text" id="companyInput" placeholder="Enter a company name or ticker to analyze stock">
                <button onclick="searchStock()" id="searchBtn" data-umami-event="search button">Analyze Stock</button>
            </div>
            <div class="loading" id="loading">Getting stock market data...</div>
            <div id="errorMessage"></div>
        </div>
        <div class="trending-section" id="trendingSection" style="margin-bottom: 40px;">
            <div class="section-title" style="margin-bottom: 15px;">Live Trending Dashboards</div>
            <div class="trending-tabs" id="trendingTabs">
                <button class="trending-tab-btn" data-source="stocktwits">Top Stocks StockTwits</button>
                <button class="trending-tab-btn active" data-source="reddit" data-umami-event="top stocks reddit">Top Stocks Reddit</button>
                <button class="trending-tab-btn" data-source="volume" data-umami-event="top stocks volume">Top Stocks Volume</button>
            </div>
            <div class="trending-columns" id="trendingColumns">
                <div class="trending-column" data-source="stocktwits">
                    <div class="trending-column-title">Top Stocks on StockTwits</div>
                    <div id="stocktwitsList" class="trending-list"></div>
                </div>
                <div class="trending-column active" data-source="reddit">
                    <div class="trending-column-title">Top Stocks on Reddit</div>
                    <div id="redditList" class="trending-list"></div>
                </div>
                <div class="trending-column" data-source="volume">
                    <div class="trending-column-title">Most Active by Volume</div>
                    <div id="volumeList" class="trending-list"></div>
                </div>
            </div>
        </div>

        <div class="watchlist-section" id="watchlistSection" {% if page_view != 'watchlist' %}style="display:none;"{% endif %}>
            <div class="section-title" style="margin-bottom: 15px;">Your Watchlist</div>
            <div id="watchlistEmptyState" class="watchlist-empty">Save tickers to build a personalized list you can revisit with one click.</div>
            <div id="watchlistList" class="watchlist-list"></div>
        </div>

        <div class="market-summary-section" id="marketSummarySection" {% if page_view != 'market' %}style="display:none;"{% endif %}>
            <div class="section-title" style="margin-bottom: 10px;">Daily Market Summary</div>
            <p class="market-summary-note">Fresh articles publish weekdays at 4:15 PM ET.</p>
            <div class="market-summary-signup" id="marketSummarySignupCard">
                <h3>Get the recap in your inbox</h3>
                <p>Sign up to get the market summary delivered to your inbox, weekdays at 4:15 PM ET.</p>
                <form id="marketSummarySignupForm" novalidate>
                    <input type="email" id="marketSummaryEmail" name="email" placeholder="you@example.com" autocomplete="email" required>
                    <button type="submit" id="marketSummarySignupButton" data-umami-event="market summary signup">Notify Me</button>
                </form>
                <p class="market-summary-signup-status" id="marketSummarySignupStatus" aria-live="polite"></p>
            </div>
            <div id="marketSummaryLatest" class="market-summary-latest">
                <div class="market-summary-empty">Latest edition will appear here.</div>
            </div>
            <div class="section-title" style="margin: 20px 0 10px; font-size: 18px;">Recent Editions</div>
            <div class="market-summary-archive" id="marketSummaryArchive"></div>
        </div>

        <div id="results">
            <div class="stock-header">
                <div class="company-header">
                    <div class="company-name" id="companyName"></div>
                    <button type="button" id="watchlistToggleBtn" class="watchlist-toggle-btn" style="display:none;" aria-pressed="false" title="Toggle watchlist" data-umami-event="toggle watchlist">Add to Watchlist</button>
                </div>
                <div class="stock-price" id="stockPrice"></div>
                <div class="price-change" id="priceChange"></div>
                <div class="price-change" id="afterHoursChange"></div>
            </div>
            <div class="sentiment-summary">
                    <div class="sentiment-item">
                        <div class="sentiment-label">POSITIVE</div>
                        <div class="sentiment-value positive" id="positiveCount">0</div>
                    </div>
                    <div class="sentiment-item">
                        <div class="sentiment-label">NEGATIVE</div>
                        <div class="sentiment-value negative" id="negativeCount">0</div>
                    </div>
                    <div class="sentiment-item">
                        <div class="sentiment-label">NEUTRAL</div>
                        <div class="sentiment-value" style="color: #888;" id="neutralCount">0</div>
                    </div>
                    <div class="sentiment-item">
                        <div class="sentiment-label">OVERALL SENTIMENT</div>
                        <div class="sentiment-value" id="overallSentiment">-</div>
                    </div>
                    <div class="sentiment-summary-spinner" aria-hidden="true"></div>
                </div>
                <div class="sentiment-status" id="sentimentStatus" aria-live="polite"></div>
                <div class="sentiment-progress" id="sentimentProgress" aria-hidden="true">
                    <div class="sentiment-progress-bar"></div>
                </div>
                <div class="chart-container">
                <div class="chart-tabs">
                    <span class="chart-tab active" data-period="1d">1D</span>
                    <span class="chart-tab" data-period="5d">1W</span>
                    <span class="chart-tab" data-period="1mo">1M</span>
                    <span class="chart-tab" data-period="3mo">3M</span>
                    <span class="chart-tab" data-period="ytd">YTD</span>
                    <span class="chart-tab" data-period="1y">1Y</span>
                    <span class="chart-tab" data-period="5y">5Y</span>
                    <span class="chart-tab" data-period="max">ALL</span>
                </div>
                <canvas id="stockChart"></canvas>
            </div>

            <div class="movement-box" id="movementBox" style="display:none;">
                <div class="movement-title">What's Happening:</div>
                <div class="movement-meta" id="movementMeta"></div>
                <p class="movement-summary" id="movementSummary"></p>
                <ul class="movement-sources" id="movementSources"></ul>
            </div>

            <div class="info-section">
                <div class="section-title">About <span id="aboutSymbol"></span></div>
                <div class="about-text-wrapper">
                    <span class="about-text" id="aboutText"></span><button id="toggleAboutBtn" type="button" style="display:none;">View More</button>
                </div>
                <div class="company-details">
                    <div class="detail-item">
                        <div class="detail-label">CEO</div>
                        <div class="detail-value" id="ceo">-</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">Employees</div>
                        <div class="detail-value" id="employees">-</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">Headquarters</div>
                        <div class="detail-value" id="headquarters">-</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">Founded</div>
                        <div class="detail-value" id="founded">-</div>
                    </div>
                </div>

                <div class="section-title" style="margin-top: 30px;">Key Statistics</div>
                <div class="stats-grid">
                    <div class="stat-item">
                        <div class="stat-label">Market cap</div>
                        <div class="stat-value" id="marketCap">-</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-label">PE ratio</div>
                        <div class="stat-value" id="peRatio">-</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-label">Dividend yield</div>
                        <div class="stat-value" id="dividendYield">-</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-label">Average volume</div>
                        <div class="stat-value" id="avgVolume">-</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-label">High today</div>
                        <div class="stat-value" id="highToday">-</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-label">Low today</div>
                        <div class="stat-value" id="lowToday">-</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-label">Open price</div>
                        <div class="stat-value" id="openPrice">-</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-label">Volume</div>
                        <div class="stat-value" id="volume">-</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-label">52 Week high</div>
                        <div class="stat-value" id="fiftyTwoWeekHigh">-</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-label">52 Week low</div>
                        <div class="stat-value" id="fiftyTwoWeekLow">-</div>
                    </div>
                </div>
            </div>

            <div class="news-section">
                <div class="section-title">News & Sentiment Analysis</div>

                

                <div id="newsArticles"></div>
            </div>
        </div>
    </div>

    {% if initial_market_summary_article is defined and initial_market_summary_article %}
    <script id="initialMarketSummaryArticle" type="application/json">{{ initial_market_summary_article | tojson }}</script>
    {% endif %}

    <script>
    let chart = null;
    let currentSymbol = null;
    let historicalData = {};
    const movementBox = document.getElementById('movementBox');
    const movementSummaryEl = document.getElementById('movementSummary');
    const movementMetaEl = document.getElementById('movementMeta');
    const movementSourcesEl = document.getElementById('movementSources');
    const trendingLists = {
        stocktwits: document.getElementById('stocktwitsList'),
        reddit: document.getElementById('redditList'),
        volume: document.getElementById('volumeList')
    };
    const TRENDING_SOURCES = ['stocktwits', 'reddit', 'volume'];
    function normalizeTrendingSource(value) {
        const normalized = (value || '').toString().trim().toLowerCase();
        if (TRENDING_SOURCES.includes(normalized)) {
            return normalized;
        }
        return TRENDING_SOURCES[0];
    }

    function resolveTrendingSourceFromPath(pathname) {
        const match = pathname && pathname.match(/^\/trending-list(?:\/([a-z]+))?$/);
        if (match && match[1]) {
            return normalizeTrendingSource(match[1]);
        }
        return TRENDING_SOURCES[0];
    }

    function buildTrendingPath(source) {
        const normalized = normalizeTrendingSource(source);
        return `/trending-list/${normalized}`;
    }
    const TRENDING_CACHE_TTL_MS = 5 * 60 * 1000;
    const TRENDING_INCLUDE_PRICES = false;
    const trendingCache = {};
    const trendingFetchPromises = {};
    const trendingPriceHydrations = new Map();
    const stocktwitsSummaryCache = new Map();
    const stocktwitsSummaryPromises = new Map();
    let stocktwitsSummaryPopover = null;
    let stocktwitsPopoverHeading = null;
    let stocktwitsPopoverBody = null;
    let stocktwitsPopoverMeta = null;
    const sentenceAbbreviations = new Set([
        'inc', 'incorporated', 'corp', 'corporation', 'co', 'ltd', 'llc', 'plc',
        'sr', 'jr', 'dr', 'mr', 'mrs', 'ms', 'prof', 'dept', 'st'
    ]);
    const WATCHLIST_STORAGE_KEY = 'ssa_watchlist_v1';
    const watchlistToggleBtn = document.getElementById('watchlistToggleBtn');
    const watchlistListEl = document.getElementById('watchlistList');
    const watchlistEmptyStateEl = document.getElementById('watchlistEmptyState');
    const watchlistSectionEl = document.getElementById('watchlistSection');
    const marketSummarySectionEl = document.getElementById('marketSummarySection');
    const marketSummaryLatestEl = document.getElementById('marketSummaryLatest');
    const marketSummaryArchiveEl = document.getElementById('marketSummaryArchive');
    const marketSummaryFormEl = document.getElementById('marketSummarySignupForm');
    const marketSummaryEmailInputEl = document.getElementById('marketSummaryEmail');
    const marketSummarySignupStatusEl = document.getElementById('marketSummarySignupStatus');
    const marketSummarySignupButtonEl = document.getElementById('marketSummarySignupButton');
    const marketSummarySlug = document.body.dataset.marketArticleSlug || '';
    const initialMarketSummaryArticleEl = document.getElementById('initialMarketSummaryArticle');
    let initialMarketSummaryArticle = null;
    if (initialMarketSummaryArticleEl) {
        try {
            initialMarketSummaryArticle = JSON.parse(initialMarketSummaryArticleEl.textContent);
        } catch (error) {
            console.error('Unable to parse initial market summary payload:', error);
        }
    }
    const pageVariant = document.body.dataset.page || 'home';
    const initialSearchQuery = document.body.dataset.searchQuery || '';
    const isHomePage = pageVariant === 'home';
    const isWatchlistPage = pageVariant === 'watchlist';
    const isTrendingPage = pageVariant === 'trending';
    const isSearchPage = pageVariant === 'search';
    const isMarketPage = pageVariant === 'market';
    const homeTitleEl = document.getElementById('homeTitle');
    const trendingBtnEl = document.getElementById('trendingBtn');
    const watchlistNavBtnEl = document.getElementById('watchlistNavBtn');
    const marketSummaryBtnEl = document.getElementById('marketSummaryBtn');
    const unsplashReferralFallback = document.body.dataset.unsplashRef || 'https://unsplash.com/?utm_source=stocks-sentiment-analysis&utm_medium=referral';
    let currentTrendingSource = normalizeTrendingSource(document.body.dataset.trendingSource || '');
    let watchlistStorageAvailable = true;
    let watchlistHasEntries = false;
    let homePrimaryPanel = 'watchlist';
    let homePanelInitialized = false;
    let homeTrendingInitialized = false;
    let watchlistPriceRefreshPromise = null;
    let activeSentimentRunId = 0;
    let latestSentimentCounts = { positive: 0, negative: 0, neutral: 0 };
    const sentimentStatusEl = document.getElementById('sentimentStatus');
    const sentimentProgressEl = document.getElementById('sentimentProgress');
    const sentimentProgressBarEl = sentimentProgressEl ? sentimentProgressEl.querySelector('.sentiment-progress-bar') : null;
    let sentimentBatchSize = 0;
    const SENTIMENT_REQUEST_TIMEOUT_MS = 25000;
    const SENTIMENT_RETRY_TIMEOUT_MS = 45000;

        function formatNumber(num) {
            if (num >= 1e12) return (num / 1e12).toFixed(2) + 'T';
            if (num >= 1e9) return (num / 1e9).toFixed(2) + 'B';
            if (num >= 1e6) return (num / 1e6).toFixed(2) + 'M';
            if (num >= 1e3) return (num / 1e3).toFixed(2) + 'K';
            return num.toFixed(2);
        }

        function escapeAttribute(value) {
            if (value === undefined || value === null) return '';
            return String(value)
                .replace(/&/g, '&amp;')
                .replace(/"/g, '&quot;');
        }

        function formatCurrency(num) {
            if (!Number.isFinite(num)) return '$0.00';
            const sign = num < 0 ? '-' : '';
            return sign + '$' + Math.abs(num).toFixed(2);
        }

        function formatPercentage(num) {
            return num.toFixed(2) + '%';
        }

        function formatSignedPercentage(num) {
            if (!Number.isFinite(num)) return '0.00%';
            const sign = num >= 0 ? '+' : '';
            return `${sign}${num.toFixed(2)}%`;
        }

        function formatOptionalCurrency(value) {
            const num = Number(value);
            if (!Number.isFinite(num)) return null;
            return '$' + num.toFixed(2);
        }

        function formatTrendPercent(value) {
            const num = Number(value);
            if (!Number.isFinite(num)) return null;
            const sign = num > 0 ? '+' : '';
            return `${sign}${num.toFixed(1)}%`;
        }

        function buildTrendChangeBadge(value, extraClass = '') {
            const rawString = value === null || value === undefined ? '' : String(value);
            const forceNeutral = rawString.toLowerCase().includes('e');
            const num = Number(value);
            if (!Number.isFinite(num) && !forceNeutral) return '';
            const renderNeutral = () => {
                const classes = ['trending-change', 'neutral'];
                if (extraClass) classes.push(extraClass);
                return `<span class="${classes.join(' ')}">0.00%</span>`;
            };
            if (forceNeutral || Object.is(num, 0)) {
                return renderNeutral();
            }
            const direction = num >= 0 ? 'positive' : 'negative';
            const classes = ['trending-change', direction];
            if (extraClass) classes.push(extraClass);
            const qualifier = num >= 0 ? 'up' : 'down';
            return `<span class="${classes.join(' ')}">${qualifier} ${formatSignedPercentage(num)}</span>`;
        }

        function updateTrendingChangeBadges(itemEl, changeValue) {
            if (!itemEl) return;
            const inlineTarget = itemEl.querySelector('[data-change-inline]');
            const rightTarget = itemEl.querySelector('[data-change-right]');
            const inlineMarkup = buildTrendChangeBadge(changeValue, 'trending-change-inline');
            if (inlineTarget) {
                inlineTarget.innerHTML = inlineMarkup || '';
            }
            const rightMarkup = buildTrendChangeBadge(changeValue, 'trending-change-right');
            if (rightTarget) {
                rightTarget.innerHTML = rightMarkup || '';
            }
        }

        function findTrendingItemElement(source, ticker) {
            const list = trendingLists[source];
            if (!list || !ticker) return null;
            const normalized = ticker.toUpperCase();
            return Array.from(list.querySelectorAll('.trending-item')).find(item => {
                return (item.dataset.ticker || '').toUpperCase() === normalized;
            }) || null;
        }

        function applyTrendingPriceUpdate(source, ticker, changePercent) {
            if (!ticker) return;
            const targetItem = findTrendingItemElement(source, ticker);
            if (!targetItem) return;
            updateTrendingChangeBadges(targetItem, changePercent);
        }

        function hydrateTrendingPrices(source, items) {
            if (!Array.isArray(items) || !items.length) return null;
            if (!trendingLists[source]) return null;

            const tickers = Array.from(new Set(
                items.slice(0, 12)
                    .map(item => (item.ticker || '').toUpperCase())
                    .filter(Boolean)
            ));
            if (!tickers.length) return null;

            const hydrationKey = `${source}:${tickers.join(',')}`;
            if (trendingPriceHydrations.has(hydrationKey)) {
                return trendingPriceHydrations.get(hydrationKey);
            }

            const hydrationPromise = (async () => {
                const quotePromises = tickers.map(async ticker => {
                    try {
                        const quote = await fetchQuote(ticker);
                        if (quote && typeof quote.change_percent === 'number') {
                            applyTrendingPriceUpdate(source, ticker, Number(quote.change_percent));
                        }
                    } catch (error) {
                        console.error('Trending price hydrate error:', ticker, error);
                    }
                });
                await Promise.allSettled(quotePromises);
            })().finally(() => {
                trendingPriceHydrations.delete(hydrationKey);
            });

            trendingPriceHydrations.set(hydrationKey, hydrationPromise);
            return hydrationPromise;
        }

        function formatRelativeTimeFromISOString(isoString) {
            if (!isoString) return '';
            const date = new Date(isoString);
            if (Number.isNaN(date.getTime())) return '';
            const diffMinutes = Math.max(0, Math.floor((Date.now() - date.getTime()) / 60000));
            if (diffMinutes < 1) return 'just now';
            if (diffMinutes < 60) return `${diffMinutes}m ago`;
            const diffHours = Math.floor(diffMinutes / 60);
            if (diffHours < 24) return `${diffHours}h ago`;
            const diffDays = Math.floor(diffHours / 24);
            return `${diffDays}d ago`;
        }

        function formatMarketSummaryTimestamp(isoString) {
            if (!isoString) return 'Pending release';
            const date = new Date(isoString);
            if (Number.isNaN(date.getTime())) return 'Pending release';
            // Detect US locale, use MM/DD/YYYY; else DD/MM/YYYY
            const locale = navigator.language || 'en';
            const isUS = locale.startsWith('en-US');
            const y = date.getFullYear();
            const m = String(date.getMonth() + 1).padStart(2, '0');
            const d = String(date.getDate()).padStart(2, '0');
            let hour = date.getHours();
            const min = String(date.getMinutes()).padStart(2, '0');
            const ampm = hour >= 12 ? 'PM' : 'AM';
            hour = hour % 12;
            if (hour === 0) hour = 12;
            const hourStr = String(hour).padStart(2, '0');
            const dateStr = isUS ? `${m}/${d}/${y}` : `${d}/${m}/${y}`;
            return `${dateStr}, ${hourStr}:${min} ${ampm}`;
        }

        function renderSentimentSummaryUI(counts, completedTotal = 0, loading = false) {
            updateSentimentProgress(completedTotal, Boolean(loading));
            const positive = counts.positive || 0;
            const negative = counts.negative || 0;
            const neutral = counts.neutral || 0;
            const total = completedTotal || (positive + negative + neutral);

            const summaryEl = document.querySelector('.sentiment-summary');
            if (summaryEl) {
                summaryEl.classList.toggle('is-loading', Boolean(loading));
            }

            function percent(val) {
                 if (!total) return loading ? '...' : '0%';
                return ((val / total) * 100).toFixed(0) + '%';
            }

            document.getElementById('positiveCount').textContent = percent(positive);
            document.getElementById('negativeCount').textContent = percent(negative);
            document.getElementById('neutralCount').textContent = percent(neutral);

            const overallElement = document.getElementById('overallSentiment');
            let overall = '';
            let overallClass = 'neutral';
            if (total > 0) {
                const entries = [
                    ['positive', positive],
                    ['negative', negative],
                    ['neutral', neutral]
                ];
                entries.sort((a, b) => b[1] - a[1]);
                overall = entries[0][0];
                overallClass = overall;
            } else if (loading) {
                overall = '';
            }
            overallElement.textContent = (overall || '').toUpperCase();
            overallElement.className = 'sentiment-value ' + overallClass;
        }

        function resetSentimentSummaryUI() {
            latestSentimentCounts = { positive: 0, negative: 0, neutral: 0 };
            sentimentBatchSize = 0;
            updateSentimentProgress(0, false);
            renderSentimentSummaryUI(latestSentimentCounts, 0, true);
        }

        function setSentimentStatus(message, tone = 'default') {
            if (!sentimentStatusEl) return;
            const shouldHide = !message;
            sentimentStatusEl.style.display = shouldHide ? 'none' : 'block';
            if (shouldHide) {
                sentimentStatusEl.textContent = '';
                return;
            }
            sentimentStatusEl.textContent = message;
            sentimentStatusEl.style.color = tone === 'error' ? '#ef4444' : '#a1a1aa';
        }

        function setMarketSummarySignupStatus(message, tone = 'default') {
            if (!marketSummarySignupStatusEl) return;
            marketSummarySignupStatusEl.textContent = message || '';
            marketSummarySignupStatusEl.classList.remove('success', 'error');
            if (!message) {
                return;
            }
            if (tone === 'success') {
                marketSummarySignupStatusEl.classList.add('success');
            } else if (tone === 'error') {
                marketSummarySignupStatusEl.classList.add('error');
            }
        }

        async function handleMarketSummarySignup(event) {
            event.preventDefault();
            if (!marketSummaryEmailInputEl || !marketSummarySignupButtonEl) return;
            const email = marketSummaryEmailInputEl.value.trim();
            if (!email) {
                setMarketSummarySignupStatus('Enter your email to subscribe.', 'error');
                marketSummaryEmailInputEl.focus();
                return;
            }
            setMarketSummarySignupStatus('Signing you up...');
            marketSummarySignupButtonEl.disabled = true;
            try {
                const res = await fetch('/api/market-summary/subscribe', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ email })
                });
                const payload = await res.json();
                if (!res.ok) {
                    throw new Error(payload && payload.error ? payload.error : 'Unable to subscribe.');
                }
                setMarketSummarySignupStatus(payload.message || 'Check your inbox to confirm.', 'success');
                marketSummaryEmailInputEl.value = '';
            } catch (error) {
                const fallbackMessage = (error && error.message) ? error.message : 'Unable to subscribe right now.';
                setMarketSummarySignupStatus(fallbackMessage, 'error');
            } finally {
                marketSummarySignupButtonEl.disabled = false;
            }
        }

        function updateSentimentProgress(completed = 0, loading = false) {
            if (!sentimentProgressEl || !sentimentProgressBarEl) return;
            if (!loading || sentimentBatchSize <= 0) {
                sentimentProgressEl.classList.remove('is-active');
                sentimentProgressEl.setAttribute('aria-hidden', 'true');
                sentimentProgressBarEl.style.width = '0%';
                return;
            }
            const ratio = sentimentBatchSize ? Math.min(1, completed / sentimentBatchSize) : 0;
            sentimentProgressEl.classList.add('is-active');
            sentimentProgressEl.setAttribute('aria-hidden', 'false');
            sentimentProgressBarEl.style.width = `${(ratio * 100).toFixed(2)}%`;
        }

        function createParagraphNodes(container, text) {
            const bodyText = (text || '').split(/\n+/).map(p => p.trim()).filter(Boolean);
            if (!bodyText.length) {
                const fallback = document.createElement('p');
                fallback.textContent = 'Summary coming soon.';
                container.appendChild(fallback);
                return;
            }
            bodyText.forEach(chunk => {
                const p = document.createElement('p');
                p.textContent = chunk;
                container.appendChild(p);
            });
        }

        function readWatchlist() {
            if (!watchlistStorageAvailable || typeof localStorage === 'undefined') {
                return [];
            }
            try {
                const raw = localStorage.getItem(WATCHLIST_STORAGE_KEY);
                if (!raw) return [];
                const parsed = JSON.parse(raw);
                if (Array.isArray(parsed)) {
                    return parsed.filter(item => item && item.symbol);
                }
            } catch (error) {
                console.error('Watchlist storage error:', error);
                watchlistStorageAvailable = false;
            }
            return [];
        }

        function writeWatchlist(items) {
            if (!watchlistStorageAvailable || typeof localStorage === 'undefined') return;
            try {
                localStorage.setItem(WATCHLIST_STORAGE_KEY, JSON.stringify(items));
            } catch (error) {
                console.error('Unable to persist watchlist:', error);
                watchlistStorageAvailable = false;
            }
        }

        function isSymbolInWatchlist(symbol) {
            if (!symbol) return false;
            const normalized = symbol.toUpperCase();
            return readWatchlist().some(item => item.symbol === normalized);
        }

        function addSymbolToWatchlist(entry) {
            if (!entry || !entry.symbol || !watchlistStorageAvailable) return;
            const normalized = entry.symbol.toUpperCase();
            const items = readWatchlist();
            if (items.some(item => item.symbol === normalized)) return;
            const nowIso = new Date().toISOString();
            const newEntry = {
                symbol: normalized,
                companyName: entry.companyName || normalized,
                lastPrice: Number.isFinite(entry.lastPrice) ? Number(entry.lastPrice) : null,
                lastUpdated: Number.isFinite(entry.lastPrice) ? nowIso : null,
                addedAt: nowIso
            };
            const nextItems = [newEntry, ...items].slice(0, 50);
            writeWatchlist(nextItems);
            renderWatchlist();
        }

        function removeSymbolFromWatchlist(symbol) {
            if (!symbol || !watchlistStorageAvailable) return;
            const normalized = symbol.toUpperCase();
            const filtered = readWatchlist().filter(item => item.symbol !== normalized);
            writeWatchlist(filtered);
            renderWatchlist();
        }

        function updateWatchlistSnapshot(symbol, price, companyName) {
            if (!symbol || !watchlistStorageAvailable || !isSymbolInWatchlist(symbol)) return;
            const normalized = symbol.toUpperCase();
            const items = readWatchlist();
            let changed = false;
            const updatedItems = items.map(item => {
                if (item.symbol !== normalized) return item;
                const updated = { ...item };
                if (companyName) {
                    updated.companyName = companyName;
                }
                if (Number.isFinite(price)) {
                    updated.lastPrice = Number(price);
                    updated.lastUpdated = new Date().toISOString();
                }
                changed = true;
                return updated;
            });
            if (changed) {
                writeWatchlist(updatedItems);
                renderWatchlist();
            }
        }

        function updateWatchlistToggle(symbol, companyName, price) {
            if (!watchlistToggleBtn) return;
            if (!symbol) {
                watchlistToggleBtn.style.display = 'none';
                watchlistToggleBtn.removeAttribute('data-symbol');
                return;
            }
            const normalized = symbol.toUpperCase();
            watchlistToggleBtn.style.display = 'inline-flex';
            watchlistToggleBtn.dataset.symbol = normalized;
            watchlistToggleBtn.dataset.company = companyName || normalized;
            if (Number.isFinite(price)) {
                watchlistToggleBtn.dataset.price = Number(price);
            } else {
                delete watchlistToggleBtn.dataset.price;
            }
            const saved = isSymbolInWatchlist(normalized);
            watchlistToggleBtn.textContent = saved ? 'Remove from Watchlist' : 'Add to Watchlist';
            watchlistToggleBtn.classList.toggle('saved', saved);
            watchlistToggleBtn.setAttribute('aria-pressed', saved ? 'true' : 'false');
        }

        function renderWatchlist() {
            if (!watchlistListEl) return 0;
            const items = readWatchlist();
            watchlistHasEntries = items.length > 0;
            if (!items.length) {
                watchlistListEl.innerHTML = '';
                if (watchlistEmptyStateEl) {
                    watchlistEmptyStateEl.style.display = 'block';
                }
                if (isWatchlistPage) {
                    watchlistSectionEl.style.display = '';
                } else if (!isHomePage) {
                    showWatchlistSection(false);
                }
                if (isHomePage) {
                    setHomePrimaryPanel('trending');
                }
                return 0;
            }
            if (watchlistEmptyStateEl) {
                watchlistEmptyStateEl.style.display = 'none';
            }
            watchlistListEl.innerHTML = '';
            items.forEach(item => {
                const itemDiv = document.createElement('div');
                itemDiv.className = 'watchlist-item';
                itemDiv.title = `${item.symbol}  Click to load`;
                itemDiv.addEventListener('click', () => {
                    document.getElementById('companyInput').value = item.symbol;
                    searchStock();
                });

                const left = document.createElement('div');
                left.className = 'watchlist-item-left';
                const symbolEl = document.createElement('div');
                symbolEl.className = 'watchlist-symbol';
                symbolEl.textContent = item.symbol;
                const nameEl = document.createElement('div');
                nameEl.className = 'watchlist-name';
                nameEl.textContent = item.companyName || '';
                left.appendChild(symbolEl);
                left.appendChild(nameEl);

                const meta = document.createElement('div');
                meta.className = 'watchlist-meta';
                if (Number.isFinite(item.lastPrice)) {
                    const priceEl = document.createElement('div');
                    priceEl.className = 'watchlist-price';
                    priceEl.textContent = formatCurrency(item.lastPrice);
                    meta.appendChild(priceEl);
                }
                const updatedEl = document.createElement('div');
                updatedEl.className = 'watchlist-updated';
                updatedEl.textContent = item.lastUpdated
                    ? `Updated ${formatRelativeTimeFromISOString(item.lastUpdated)}`
                    : 'Tap to refresh';
                meta.appendChild(updatedEl);

                const removeBtn = document.createElement('button');
                removeBtn.type = 'button';
                removeBtn.className = 'watchlist-remove-btn';
                removeBtn.setAttribute('aria-label', `Remove ${item.symbol} from watchlist`);
                removeBtn.innerHTML = '&times;';
                removeBtn.addEventListener('click', event => {
                    event.stopPropagation();
                    removeSymbolFromWatchlist(item.symbol);
                    if (watchlistToggleBtn && watchlistToggleBtn.dataset.symbol === item.symbol) {
                        updateWatchlistToggle(item.symbol, item.companyName, Number(watchlistToggleBtn.dataset.price));
                    }
                });
                meta.appendChild(removeBtn);

                itemDiv.appendChild(left);
                itemDiv.appendChild(meta);
                watchlistListEl.appendChild(itemDiv);
            });
            if (isWatchlistPage) {
                watchlistSectionEl.style.display = '';
            } else if (!isHomePage) {
                showWatchlistSection(homePrimaryPanel === 'watchlist');
            }
            if (isHomePage) {
                setHomePrimaryPanel('watchlist');
            }
            return items.length;
        }

        function handleWatchlistToggleClick() {
            if (!watchlistToggleBtn || !watchlistStorageAvailable) return;
            const symbol = watchlistToggleBtn.dataset.symbol;
            if (!symbol) return;
            const companyName = watchlistToggleBtn.dataset.company || symbol;
            const price = Number(watchlistToggleBtn.dataset.price);
            if (isSymbolInWatchlist(symbol)) {
                removeSymbolFromWatchlist(symbol);
            } else {
                addSymbolToWatchlist({
                    symbol,
                    companyName,
                    lastPrice: Number.isFinite(price) ? price : null
                });
            }
            updateWatchlistToggle(symbol, companyName, price);
        }

        function getFirstSentence(text) {
            if (!text) return '';
            const normalized = text.replace(/\s+/g, ' ').trim();
            if (!normalized) return '';

            for (let i = 0; i < normalized.length; i++) {
                const char = normalized[i];
                if (!'.!?'.includes(char)) continue;

                const before = normalized.slice(0, i).trimEnd();
                const wordMatch = before.match(/([A-Za-z]+)$/);
                const lastWord = wordMatch ? wordMatch[1].toLowerCase() : '';
                const remainder = normalized.slice(i + 1);
                const hasMoreContent = /\S/.test(remainder);

                if (char === '.' && lastWord && sentenceAbbreviations.has(lastWord) && hasMoreContent) {
                    continue;
                }

                const sentence = normalized.slice(0, i + 1).trim();
                if (sentence.length) {
                    return sentence;
                }
            }

            const newlineSplit = text.split(/\n+/).map(part => part.replace(/\s+/g, ' ').trim()).filter(Boolean);
            if (newlineSplit.length > 0) {
                return newlineSplit[0];
            }

            return normalized;
        }

        function setTrendingListLoading(source) {
            const list = trendingLists[source];
            if (list) {
                list.innerHTML = '<div class="trending-message" style="color:#9333ea;">Loading...</div>';
            }
        }

        function showTrendingMessage(source, message, isError = false) {
            const list = trendingLists[source];
            if (!list) return;
            const color = isError ? '#ef4444' : '#888';
            list.innerHTML = `<div class="trending-message" style="color:${color};">${message}</div>`;
        }

        function isTrendingCacheFresh(entry, includePrices = true) {
            if (!entry) return false;
            if ((Date.now() - entry.timestamp) >= TRENDING_CACHE_TTL_MS) {
                return false;
            }
            if (includePrices && !entry.includePrices) {
                return false;
            }
            return true;
        }

        function getFreshTrendingCache(source, includePrices = true) {
            const entry = trendingCache[source];
            return isTrendingCacheFresh(entry, includePrices) ? entry : null;
        }

        function setTrendingCache(source, items, includePrices = true) {
            trendingCache[source] = {
                data: Array.isArray(items) ? items : [],
                timestamp: Date.now(),
                includePrices: Boolean(includePrices)
            };
        }

        function ensureStocktwitsSummaryPopover() {
            if (stocktwitsSummaryPopover) {
                return stocktwitsSummaryPopover;
            }
            const popover = document.createElement('div');
            popover.className = 'trending-summary-popover';
            popover.setAttribute('role', 'status');
            popover.innerHTML = `
                <div class="trending-summary-popover-heading" data-role="heading"></div>
                <div class="trending-summary-popover-body" data-role="body"></div>
                <div class="trending-summary-popover-meta" data-role="meta"></div>
            `;
            document.body.appendChild(popover);
            stocktwitsSummaryPopover = popover;
            stocktwitsPopoverHeading = popover.querySelector('[data-role="heading"]');
            stocktwitsPopoverBody = popover.querySelector('[data-role="body"]');
            stocktwitsPopoverMeta = popover.querySelector('[data-role="meta"]');
            return popover;
        }

        function hideStocktwitsPopover() {
            if (!stocktwitsSummaryPopover) return;
            stocktwitsSummaryPopover.classList.remove('visible', 'is-loading', 'is-error');
            stocktwitsSummaryPopover.style.display = 'none';
            stocktwitsSummaryPopover.removeAttribute('data-ticker');
        }

        function positionStocktwitsPopover(anchorEl) {
            const popover = ensureStocktwitsSummaryPopover();
            if (!anchorEl) return;
            popover.style.visibility = 'hidden';
            popover.style.display = 'block';
            const anchorRect = anchorEl.getBoundingClientRect();
            const popRect = popover.getBoundingClientRect();
            const top = window.scrollY + anchorRect.bottom + 10;
            const minLeft = window.scrollX + 12;
            const maxLeft = window.scrollX + window.innerWidth - popRect.width - 12;
            let left = window.scrollX + anchorRect.left - (popRect.width / 2) + (anchorRect.width / 2);
            left = Math.min(Math.max(left, minLeft), Math.max(minLeft, maxLeft));
            popover.style.top = `${top}px`;
            popover.style.left = `${left}px`;
            const anchorCenter = window.scrollX + anchorRect.left + (anchorRect.width / 2);
            const offsetWithinPopover = anchorCenter - left;
            const arrowOffset = Math.min(Math.max(offsetWithinPopover, 16), popRect.width - 16);
            popover.style.setProperty('--popover-arrow-offset', `${arrowOffset}px`);
            popover.style.visibility = 'visible';
        }

        function setStocktwitsPopoverState({ heading, body, meta, modifier }) {
            const popover = ensureStocktwitsSummaryPopover();
            popover.classList.remove('is-loading', 'is-error');
            if (modifier === 'loading') {
                popover.classList.add('is-loading');
            } else if (modifier === 'error') {
                popover.classList.add('is-error');
            }
            if (stocktwitsPopoverHeading) {
                stocktwitsPopoverHeading.textContent = heading || '';
            }
            if (stocktwitsPopoverBody) {
                stocktwitsPopoverBody.textContent = body || '';
            }
            if (stocktwitsPopoverMeta) {
                stocktwitsPopoverMeta.textContent = meta || '';
            }
        }

        function showStocktwitsPopover(anchorEl, ticker, state) {
            const popover = ensureStocktwitsSummaryPopover();
            popover.dataset.ticker = ticker || '';
            setStocktwitsPopoverState(state);
            popover.classList.add('visible');
            positionStocktwitsPopover(anchorEl);
        }

        function formatSummaryTimestamp(isoString) {
            if (!isoString) return '';
            const date = new Date(isoString);
            if (Number.isNaN(date.getTime())) return '';
            return date.toLocaleString(undefined, {
                month: 'short',
                day: 'numeric',
                hour: 'numeric',
                minute: '2-digit'
            });
        }

        function fetchStocktwitsSummary(ticker) {
            const normalized = (ticker || '').toUpperCase();
            if (!normalized) {
                return Promise.reject(new Error('Invalid ticker.'));
            }
            if (stocktwitsSummaryCache.has(normalized)) {
                return Promise.resolve(stocktwitsSummaryCache.get(normalized));
            }
            if (stocktwitsSummaryPromises.has(normalized)) {
                return stocktwitsSummaryPromises.get(normalized);
            }
            const promise = fetch(`/stocktwits/${encodeURIComponent(normalized)}/summary`)
                .then(res => {
                    if (!res.ok) {
                        throw new Error('Summary unavailable right now.');
                    }
                    return res.json();
                })
                .then(data => {
                    stocktwitsSummaryCache.set(normalized, data);
                    stocktwitsSummaryPromises.delete(normalized);
                    return data;
                })
                .catch(err => {
                    stocktwitsSummaryPromises.delete(normalized);
                    throw err;
                });
            stocktwitsSummaryPromises.set(normalized, promise);
            return promise;
        }

        async function toggleStocktwitsSummaryPopover(anchorEl, ticker, name) {
            if (!anchorEl || !ticker) return;
            const normalized = ticker.toUpperCase();
            const headingTitle = name
                ? `${name} (${normalized}) on StockTwits`
                : `${normalized} on StockTwits`;
            const visiblePopover = stocktwitsSummaryPopover && stocktwitsSummaryPopover.classList.contains('visible');
            if (visiblePopover && stocktwitsSummaryPopover.dataset.ticker === normalized) {
                hideStocktwitsPopover();
                return;
            }
            showStocktwitsPopover(anchorEl, normalized, {
                heading: headingTitle,
                body: 'Loading summary',
                meta: '',
                modifier: 'loading'
            });
            try {
                const data = await fetchStocktwitsSummary(normalized);
                const summaryText = (data.summary || '').trim() || 'No StockTwits summary available yet.';
                const timestampText = formatSummaryTimestamp(data.summary_meta && data.summary_meta.summary_at);
                showStocktwitsPopover(anchorEl, normalized, {
                    heading: headingTitle,
                    body: summaryText,
                    meta: timestampText ? `Updated ${timestampText}` : ''
                });
            } catch (error) {
                const message = (error && error.message) || 'Summary unavailable.';
                showStocktwitsPopover(anchorEl, normalized, {
                    heading: headingTitle,
                    body: message,
                    meta: '',
                    modifier: 'error'
                });
            }
        }

        function renderTrendingData(source, items) {
            if (source === 'stocktwits') {
                renderStocktwitsList(items);
            } else if (source === 'reddit') {
                renderRedditList(items);
            } else if (source === 'volume') {
                renderVolumeList(items);
            }
        }

        function showWatchlistSection(show) {
            if (!watchlistSectionEl) return;
            if (isWatchlistPage) {
                watchlistSectionEl.style.display = show === false ? 'none' : '';
                return;
            }
            if (isTrendingPage || isSearchPage || isMarketPage) {
                watchlistSectionEl.style.display = 'none';
                return;
            }
            if (!watchlistHasEntries) {
                watchlistSectionEl.style.display = 'none';
                return;
            }
            watchlistSectionEl.style.display = show ? '' : 'none';
        }

        function setHomePrimaryPanel(panel) {
            if (!isHomePage) return;
            const normalizedPanel = panel === 'trending' ? 'trending' : 'watchlist';
            homePrimaryPanel = normalizedPanel;
            const shouldShowWatchlist = watchlistHasEntries && normalizedPanel === 'watchlist';
            const shouldShowTrending = !shouldShowWatchlist;
            showWatchlistSection(shouldShowWatchlist);
            showTrendingSection(shouldShowTrending);
            if (shouldShowWatchlist) {
                refreshWatchlistPrices();
            } else if (shouldShowTrending) {
                ensureHomeTrendingLoaded();
            }
        }

        function initializeHomePanel(watchlistCount) {
            if (!isHomePage || homePanelInitialized) return;
            homePanelInitialized = true;
            const targetPanel = watchlistCount > 0 ? 'watchlist' : 'trending';
            setHomePrimaryPanel(targetPanel);
        }

        async function fetchQuote(symbol) {
            if (!symbol) return null;
            try {
                const res = await fetch(`/quote/${encodeURIComponent(symbol)}`);
                if (!res.ok) {
                    throw new Error(`Quote fetch failed for ${symbol}`);
                }
                return await res.json();
            } catch (error) {
                console.error('Quote fetch error:', error);
                return null;
            }
        }

        async function fetchJson(url) {
            const response = await fetch(url);
            if (!response.ok) {
                let message = 'Request failed';
                try {
                    const data = await response.json();
                    if (data && data.error) {
                        message = data.error;
                    }
                } catch (err) {
                    // ignore parse errors
                }
                throw new Error(message);
            }
            return response.json();
        }

        async function refreshWatchlistPrices() {
            if (watchlistPriceRefreshPromise || !watchlistHasEntries) return;
            const items = readWatchlist();
            if (!items.length) return;
            watchlistPriceRefreshPromise = (async () => {
                try {
                    const quotes = await Promise.all(items.map(item => fetchQuote(item.symbol)));
                    let changed = false;
                    const nextItems = items.map((item, idx) => {
                        const quote = quotes[idx];
                        if (quote && Number.isFinite(quote.price)) {
                            changed = true;
                            return {
                                ...item,
                                lastPrice: Number(quote.price),
                                lastUpdated: quote.timestamp || new Date().toISOString()
                            };
                        }
                        return item;
                    });
                    if (changed) {
                        writeWatchlist(nextItems);
                        renderWatchlist();
                    }
                } catch (err) {
                    console.error('Watchlist refresh error:', err);
                } finally {
                    watchlistPriceRefreshPromise = null;
                }
            })();
            return watchlistPriceRefreshPromise;
        }

        function hideWatchlistForStockView() {
            if (!watchlistSectionEl) return;
            if (isWatchlistPage) {
                watchlistSectionEl.style.display = 'none';
            } else {
                showWatchlistSection(false);
            }
        }

        async function fetchSentimentWithTimeout(article, companyName, idx, timeoutMs, runId) {
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), timeoutMs);
            try {
                const normalizedRunId = runId === undefined || runId === null ? '' : String(runId);
                const res = await fetch('/sentiment', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        title: article.title,
                        description: article.description,
                        company_name: companyName,
                        article_id: idx,
                        sentiment_run_id: normalizedRunId || undefined
                    }),
                    signal: controller.signal
                });
                const payload = await res.json();
                if (!res.ok) {
                    throw new Error(payload.error || 'Failed to analyze sentiment');
                }
                return payload.sentiment || 'neutral';
            } finally {
                clearTimeout(timeoutId);
            }
        }

        function renderStocktwitsList(items) {
            const list = trendingLists.stocktwits;
            if (!list) return;
            hideStocktwitsPopover();
            if (!Array.isArray(items) || items.length === 0) {
                showTrendingMessage('stocktwits', 'No StockTwits data available right now.');
                return;
            }

            list.innerHTML = '';
            items.slice(0, 10).forEach((item, idx) => {
                const div = document.createElement('div');
                div.className = 'trending-item';
                div.dataset.ticker = (item.ticker || '').toUpperCase();
                div.onclick = () => {
                    document.getElementById('companyInput').value = item.ticker;
                    searchStock();
                };

                const watchersCount = Number(item.watchlist_count);
                let watchersTag = '';
                if (Number.isFinite(watchersCount) && watchersCount > 0) {
                    watchersTag = `<span class="trending-tag">${formatNumber(watchersCount)} watchers</span>`;
                } else {
                    watchersTag = '<span class="trending-tag" style="background:rgba(88,28,135,0.25);color:#e9d5ff;">Watchers N/A</span>';
                }
                const changeValue = item.price_change_percent ?? item.change_percent;
                const metricsPieces = [];
                if (watchersTag) metricsPieces.push(watchersTag);
                const metricsRow = metricsPieces.length ? `<div class="trending-metrics-row">${metricsPieces.join('')}</div>` : '';
                const infoButtonHtml = item.ticker && (item.rank || idx + 1) <= 10
                    ? '<button class="trending-info-btn" type="button" aria-label="View StockTwits summary"><span class="icon">i</span></button>'
                    : '';

                div.innerHTML = `
                    <span class="trending-rank">${item.rank || idx + 1}.</span>
                    <div class="trending-card-content">
                        <div class="trending-ticker-row">
                            <span class="trending-ticker">${item.ticker || 'N/A'}</span>
                            ${infoButtonHtml}
                            <span class="trending-change-inline" data-change-inline></span>
                        </div>
                        ${metricsRow}
                        <span class="trending-name">${item.name || ''}</span>
                    </div>
                    <div class="trending-card-aside" data-change-right></div>
                `;
                const infoBtn = div.querySelector('.trending-info-btn');
                if (infoBtn) {
                    infoBtn.addEventListener('click', (event) => {
                        event.stopPropagation();
                        toggleStocktwitsSummaryPopover(infoBtn, item.ticker, item.name);
                    });
                }
                updateTrendingChangeBadges(div, changeValue);
                list.appendChild(div);
            });
        }

        function renderRedditList(items) {
            const list = trendingLists.reddit;
            if (!list) return;
            if (!Array.isArray(items) || items.length === 0) {
                showTrendingMessage('reddit', 'No Reddit trending data available.');
                return;
            }

            list.innerHTML = '';
            items.slice(0, 10).forEach((item, idx) => {
                const div = document.createElement('div');
                div.className = 'trending-item';
                div.dataset.ticker = (item.ticker || '').toUpperCase();
                div.onclick = () => {
                    document.getElementById('companyInput').value = item.ticker;
                    searchStock();
                };
                const pct = Number(item.pct_increase || 0);
                const pctClass = pct < 0 ? 'negative' : 'positive';
                const pctLabel = `${pct >= 0 ? '+' : ''}${Math.round(pct)}% mentions`;
                const tag = item.tag ? `<span class="trending-tag">${item.tag}</span>` : '';
                const metricsPieces = [];
                if (tag) metricsPieces.push(tag);
                const metricsRow = metricsPieces.length ? `<div class="trending-metrics-row">${metricsPieces.join('')}</div>` : '';

                div.innerHTML = `
                    <span class="trending-rank">${item.rank || idx + 1}.</span>
                    <div class="trending-card-content">
                        <div class="trending-ticker-row">
                            <span class="trending-ticker">${item.ticker || 'N/A'}</span>
                            <span class="trending-change-inline" data-change-inline></span>
                        </div>
                        ${metricsRow}
                        <span class="trending-name">${item.name || ''}</span>
                        <span class="trending-pct ${pctClass}">${pctLabel}</span>
                    </div>
                    <div class="trending-card-aside" data-change-right></div>
                `;
                updateTrendingChangeBadges(div, item.price_change_percent);
                list.appendChild(div);
            });
        }

        function renderVolumeList(items) {
            const list = trendingLists.volume;
            if (!list) return;
            if (!Array.isArray(items) || items.length === 0) {
                showTrendingMessage('volume', 'No volume leaders available.');
                return;
            }

            list.innerHTML = '';
            items.slice(0, 10).forEach((item, idx) => {
                const div = document.createElement('div');
                div.className = 'trending-item';
                div.dataset.ticker = (item.ticker || '').toUpperCase();
                div.onclick = () => {
                    document.getElementById('companyInput').value = item.ticker;
                    searchStock();
                };
                const volumeCount = Number(item.volume);
                const volumeLabel = Number.isFinite(volumeCount) && volumeCount > 0
                    ? `${formatNumber(volumeCount)} shares`
                    : 'Volume unavailable';
                const volumeTag = `<span class="trending-tag">${volumeLabel}</span>`;
                const changeValue = item.price_change_percent ?? item.change_percent;
                const metricsPieces = [];
                if (volumeTag) metricsPieces.push(volumeTag);
                const metricsRow = metricsPieces.length ? `<div class="trending-metrics-row">${metricsPieces.join('')}</div>` : '';

                div.innerHTML = `
                    <span class="trending-rank">${item.rank || idx + 1}.</span>
                    <div class="trending-card-content">
                        <div class="trending-ticker-row">
                            <span class="trending-ticker">${item.ticker || 'N/A'}</span>
                            <span class="trending-change-inline" data-change-inline></span>
                        </div>
                        ${metricsRow}
                        <span class="trending-name">${item.name || ''}</span>
                    </div>
                    <div class="trending-card-aside" data-change-right></div>
                `;
                updateTrendingChangeBadges(div, changeValue);
                list.appendChild(div);
            });
        }

        function renderMarketSummaryIndices(indices) {
            if (!indices || !indices.length) return null;
            const wrapper = document.createElement('div');
            wrapper.className = 'market-summary-indices';
            indices.forEach(item => {
                const card = document.createElement('div');
                card.className = 'market-index-item';
                const label = document.createElement('div');
                label.className = 'market-index-label';
                label.textContent = item.label || item.symbol || 'Index';
                const price = document.createElement('div');
                price.className = 'market-index-price';
                price.textContent = Number.isFinite(item.close) ? formatCurrency(item.close) : '';
                const change = document.createElement('div');
                change.className = 'market-index-change';
                if (Number.isFinite(item.change_percent)) {
                    change.textContent = formatSignedPercentage(item.change_percent);
                    change.classList.add(item.change_percent >= 0 ? 'positive' : 'negative');
                } else {
                    change.textContent = '';
                }
                card.appendChild(label);
                card.appendChild(price);
                card.appendChild(change);
                wrapper.appendChild(card);
            });
            return wrapper;
        }

        function renderMarketSummaryHeadlines(headlines) {
            if (!headlines || !headlines.length) return null;
            const container = document.createElement('div');
            container.className = 'market-summary-headlines';
            const title = document.createElement('h3');
            title.textContent = 'Headline drivers';
            container.appendChild(title);
            const list = document.createElement('ul');
            headlines.forEach(item => {
                const li = document.createElement('li');
                const linkTarget = item.link && item.link.startsWith('http') ? item.link : null;
                const headlineEl = linkTarget ? document.createElement('a') : document.createElement('span');
                headlineEl.textContent = item.title || 'Story';
                if (linkTarget) {
                    headlineEl.href = linkTarget;
                    headlineEl.target = '_blank';
                    headlineEl.rel = 'noopener noreferrer';
                }
                const meta = document.createElement('span');
                const metaParts = [];
                if (item.source) metaParts.push(item.source);
                if (item.publishedAt) metaParts.push(formatDate(item.publishedAt));
                meta.textContent = metaParts.join('  ');
                li.appendChild(headlineEl);
                if (metaParts.length) {
                    li.appendChild(meta);
                }
                list.appendChild(li);
            });
            container.appendChild(list);
            return container;
        }

        function renderMarketSummaryHero(imageData, titleText) {
            if (!imageData || !imageData.url) return null;
            const hero = document.createElement('div');
            hero.className = 'market-summary-hero';
            const img = document.createElement('img');
            img.src = imageData.url;
            img.alt = imageData.description || `Market illustration for ${titleText || 'market summary'}`;
            img.loading = 'lazy';
            hero.appendChild(img);

            const photographerName = imageData.photographer || imageData.photographer_username || 'Unsplash photographer';
            const photographerProfile = imageData.photographer_profile || unsplashReferralFallback;
            const unsplashLink = imageData.unsplash_link || unsplashReferralFallback;
            const attribution = document.createElement('div');
            attribution.className = 'unsplash-attribution';
            attribution.innerHTML = `Photo by <a href="${photographerProfile}" target="_blank" rel="noopener noreferrer">${photographerName}</a> on <a href="${unsplashLink}" target="_blank" rel="noopener noreferrer">Unsplash</a>`;
            hero.appendChild(attribution);

            return hero;
        }

        function renderMarketSummaryLatest(article) {
            if (!marketSummaryLatestEl) return;
            marketSummaryLatestEl.innerHTML = '';
            if (!article) {
                marketSummaryLatestEl.innerHTML = '<div class="market-summary-empty">Latest edition is not available yet. Check back after 4:15 PM ET.</div>';
                return;
            }
            const card = document.createElement('article');
            card.className = 'market-summary-card';
            const titleEl = document.createElement('h2');
            titleEl.className = 'market-summary-title';
            titleEl.textContent = article.title || 'Market Summary';
            const metaEl = document.createElement('div');
            metaEl.className = 'market-summary-meta';
            metaEl.textContent = `Published ${formatMarketSummaryTimestamp(article.published_at || article.created_at)}`;
            const heroEl = renderMarketSummaryHero(article.image, article.title);
            const bodyEl = document.createElement('div');
            bodyEl.className = 'market-summary-body';
            createParagraphNodes(bodyEl, article.body);
            card.appendChild(titleEl);
            card.appendChild(metaEl);
            if (heroEl) {
                card.appendChild(heroEl);
            }
            card.appendChild(bodyEl);
            const indicesEl = renderMarketSummaryIndices(article.indices || []);
            if (indicesEl) {
                card.appendChild(indicesEl);
            }
            const headlinesEl = renderMarketSummaryHeadlines(article.headlines || []);
            if (headlinesEl) {
                card.appendChild(headlinesEl);
            }
            if (article.permalink) {
                const shareRow = document.createElement('div');
                shareRow.className = 'market-summary-share';
                const shareLink = document.createElement('a');
                shareLink.href = article.permalink;
                shareLink.textContent = 'Open article ';
                shareRow.appendChild(shareLink);
                card.appendChild(shareRow);
            }
            marketSummaryLatestEl.appendChild(card);
        }

        function renderMarketSummaryArchive(items, latestId) {
            if (!marketSummaryArchiveEl) return;
            marketSummaryArchiveEl.innerHTML = '';
            const filtered = (items || []).filter(item => item.id !== latestId);
            if (!filtered.length) {
                marketSummaryArchiveEl.innerHTML = '<div class="market-summary-empty">No earlier editions</div>';
                return;
            }
            filtered.forEach((item, index) => {
                const details = document.createElement('details');
                details.className = 'market-summary-archive-item';
                if (index === 0) details.open = true;
                const summary = document.createElement('summary');
                const titleSpan = document.createElement('span');
                titleSpan.textContent = item.title || 'Market Summary';
                const dateSpan = document.createElement('span');
                dateSpan.style.fontSize = '13px';
                dateSpan.style.color = '#a1a1aa';
                dateSpan.textContent = formatMarketSummaryTimestamp(item.published_at || item.created_at);
                summary.appendChild(titleSpan);
                summary.appendChild(dateSpan);
                const bodyEl = document.createElement('div');
                bodyEl.className = 'market-summary-body';
                createParagraphNodes(bodyEl, item.body);
                details.appendChild(summary);
                const heroEl = renderMarketSummaryHero(item.image, item.title);
                if (heroEl) {
                    details.appendChild(heroEl);
                }
                details.appendChild(bodyEl);
                if (item.permalink) {
                    const linkRow = document.createElement('div');
                    linkRow.className = 'market-summary-share';
                    const link = document.createElement('a');
                    link.href = item.permalink;
                    link.textContent = 'Open standalone article ';
                    linkRow.appendChild(link);
                    details.appendChild(linkRow);
                }
                marketSummaryArchiveEl.appendChild(details);
            });
        }

        function setActiveTrendingColumn(source) {
            const columns = document.querySelectorAll('.trending-column');
            columns.forEach(column => {
                if (column.dataset.source === source) {
                    column.classList.add('active');
                } else {
                    column.classList.remove('active');
                }
            });
        }

        function setTrendingTabsActive(source) {
            const normalized = normalizeTrendingSource(source);
            currentTrendingSource = normalized;
            document.body.dataset.trendingSource = normalized;
            const tabs = document.querySelectorAll('.trending-tab-btn');
            tabs.forEach(tab => {
                tab.classList.toggle('active', tab.dataset.source === normalized);
            });
            setActiveTrendingColumn(normalized);
        }

        function navigateToTrendingSource(source, { replaceState = false } = {}) {
            const normalized = normalizeTrendingSource(source);
            const targetPath = buildTrendingPath(normalized);
            if (isTrendingPage) {
                if (window.location.pathname !== targetPath) {
                    const historyMethod = replaceState ? 'replaceState' : 'pushState';
                    if (typeof history[historyMethod] === 'function') {
                        history[historyMethod]({ trendingSource: normalized }, '', targetPath);
                    }
                }
                setTrendingTabsActive(normalized);
                return;
            }
            window.location.href = targetPath;
        }

        function initializeTrendingTabs() {
            const tabs = document.querySelectorAll('.trending-tab-btn');
            tabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    const source = normalizeTrendingSource(tab.dataset.source);
                    if (isTrendingPage) {
                        if (source === currentTrendingSource) return;
                        navigateToTrendingSource(source);
                        return;
                    }
                    setTrendingTabsActive(source);
                });
            });
            setTrendingTabsActive(currentTrendingSource);
        }

        async function searchStock(forcedQuery = null) {
            const inputEl = document.getElementById('companyInput');
            const companyName = (forcedQuery !== null ? forcedQuery : (inputEl ? inputEl.value : '')).trim();

            if (!companyName) {
                showError('Enter a company name');
                return;
            }

            if (!isSearchPage) {
                window.location.href = `/results?q=${encodeURIComponent(companyName)}`;
                return;
            }

            if (watchlistToggleBtn) {
                updateWatchlistToggle(null);
            }

            showTrendingSection(false);
            document.getElementById('loading').style.display = 'block';
            document.getElementById('results').style.display = 'none';
            document.getElementById('errorMessage').innerHTML = '';
            document.getElementById('searchBtn').disabled = true;

            try {
                const response = await fetch('/search', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ 
                        company_name: companyName
                    }),
                });

                const data = await response.json();

                if (!response.ok) {
                    const errorMessage = (data && data.error) ? data.error : 'Failed to fetch data';
                    const error = new Error(errorMessage);
                    error.status = response.status;
                    throw error;
                }

                displayResults(data);
                currentSymbol = data.stock_info.symbol;
                historicalData = { '1d': data.historical_data };

                document.querySelectorAll('.chart-tab').forEach(t => t.classList.remove('active'));
                document.querySelector('.chart-tab[data-period="1d"]').classList.add('active');

                document.getElementById('results').style.display = 'block';
            } catch (error) {
                const consolePayload = {
                    status: error && error.status,
                    message: (error && error.message) || 'Unknown search error'
                };
                console.error('Search error:', consolePayload);
                showError('An error ocurred while processing your request', { includeRetry: true });
            } finally {
                document.getElementById('loading').style.display = 'none';
                document.getElementById('searchBtn').disabled = false;
            }
        }

        function showError(message, options = {}) {
            const { includeRetry = false } = options;
            const container = document.getElementById('errorMessage');
            if (!container) return;
            const retryHtml = includeRetry
                ? '<button class="retry-button" type="button" id="retrySearchBtn">Try again</button>'
                : '';
            container.innerHTML = `<div class="error-message">${message}</div>${retryHtml}`;
            if (includeRetry) {
                const retryBtn = document.getElementById('retrySearchBtn');
                if (retryBtn) {
                    retryBtn.onclick = () => window.location.reload();
                }
            }
        }

        function displayResults(data) {
            const stockInfo = data.stock_info;
            const sentimentRunId = ++activeSentimentRunId;
            resetSentimentSummaryUI();
            latestSentimentCounts = { positive: 0, negative: 0, neutral: 0 };
            setSentimentStatus('Analyzing article sentiment...');
            updateWatchlistToggle(stockInfo.symbol, stockInfo.companyName, stockInfo.price);
            updateWatchlistSnapshot(stockInfo.symbol, stockInfo.price, stockInfo.companyName);
            const articles = data.articles || [];
            renderMovementInsight(data.movement_insight);
            hideWatchlistForStockView();

            document.getElementById('companyName').textContent = stockInfo.companyName;
            document.getElementById('stockPrice').textContent = formatCurrency(stockInfo.price);

            const changeClass = stockInfo.change >= 0 ? 'positive' : 'negative';
            const changeSign = stockInfo.change >= 0 ? '+' : '';
            document.getElementById('priceChange').innerHTML =
                `<span class="${changeClass}">${changeSign}${formatCurrency(stockInfo.change)} (${changeSign}${formatPercentage(stockInfo.changePercent)}) Today</span>`;

            if (stockInfo.afterHoursChange !== null && stockInfo.afterHoursChange !== undefined) {
                const ahChangeClass = stockInfo.afterHoursChange >= 0 ? 'positive' : 'negative';
                const ahChangeSign = stockInfo.afterHoursChange >= 0 ? '+' : '';
                document.getElementById('afterHoursChange').innerHTML =
                    `<span class="${ahChangeClass}">${ahChangeSign}${formatCurrency(stockInfo.afterHoursChange)} (${ahChangeSign}${formatPercentage(stockInfo.afterHoursChangePercent)}) After-hours</span>`;
            } else {
                document.getElementById('afterHoursChange').innerHTML = '';
            }

            if (data.historical_data && data.historical_data.length > 0) {
                createChart(data.historical_data);
            } else {
                createChart([]);
            }

            document.getElementById('aboutSymbol').textContent = stockInfo.symbol;
            const aboutTextElement = document.getElementById('aboutText');
            const toggleBtn = document.getElementById('toggleAboutBtn');
            const defaultDescription = `${stockInfo.companyName} (${stockInfo.symbol}) engages in various business operations. Stock data is updated in real-time.`;
            const fullDescription = (stockInfo.description || defaultDescription).trim();
            const shortText = getFirstSentence(fullDescription) || fullDescription;
            const needsToggle = shortText.length < fullDescription.length;

            aboutTextElement.dataset.fullText = fullDescription;
            aboutTextElement.dataset.shortText = shortText;
            aboutTextElement.textContent = aboutTextElement.dataset.shortText;

            if (needsToggle) {
                toggleBtn.style.display = 'inline';
                toggleBtn.textContent = 'View More';
                toggleBtn.dataset.expanded = 'false';
                toggleBtn.onclick = () => {
                    const expanded = toggleBtn.dataset.expanded === 'true';
                    if (expanded) {
                        aboutTextElement.textContent = aboutTextElement.dataset.shortText;
                        toggleBtn.textContent = 'View More';
                        toggleBtn.dataset.expanded = 'false';
                    } else {
                        aboutTextElement.textContent = aboutTextElement.dataset.fullText;
                        toggleBtn.textContent = 'View Less';
                        toggleBtn.dataset.expanded = 'true';
                    }
                };
            } else {
                toggleBtn.style.display = 'none';
                toggleBtn.textContent = '';
                toggleBtn.dataset.expanded = 'false';
                toggleBtn.onclick = null;
            }
            document.getElementById('ceo').textContent = stockInfo.ceo || 'N/A';
            document.getElementById('employees').textContent = stockInfo.employees ? formatNumber(stockInfo.employees) : 'N/A';

            let location = [];
            if (stockInfo.city) location.push(stockInfo.city);
            if (stockInfo.state) location.push(stockInfo.state);
            if (stockInfo.country && !stockInfo.state) location.push(stockInfo.country);
            document.getElementById('headquarters').textContent = location.join(', ') || 'N/A';

            document.getElementById('founded').textContent = stockInfo.yearFounded;

            document.getElementById('marketCap').textContent = stockInfo.marketCap ? '$' + formatNumber(stockInfo.marketCap) : 'N/A';
            document.getElementById('peRatio').textContent = stockInfo.peRatio ? stockInfo.peRatio.toFixed(2) : 'N/A';
            document.getElementById('dividendYield').textContent = stockInfo.dividendYield ? formatPercentage(stockInfo.dividendYield) : 'N/A';
            document.getElementById('avgVolume').textContent = stockInfo.avgVolume ? formatNumber(stockInfo.avgVolume) : 'N/A';
            document.getElementById('highToday').textContent = stockInfo.dayHigh ? formatCurrency(stockInfo.dayHigh) : 'N/A';
            document.getElementById('lowToday').textContent = stockInfo.dayLow ? formatCurrency(stockInfo.dayLow) : 'N/A';
            document.getElementById('openPrice').textContent = stockInfo.openPrice ? formatCurrency(stockInfo.openPrice) : 'N/A';
            document.getElementById('volume').textContent = stockInfo.volume ? formatNumber(stockInfo.volume) : 'N/A';
            document.getElementById('fiftyTwoWeekHigh').textContent = stockInfo.fiftyTwoWeekHigh ? formatCurrency(stockInfo.fiftyTwoWeekHigh) : 'N/A';
            document.getElementById('fiftyTwoWeekLow').textContent = stockInfo.fiftyTwoWeekLow ? formatCurrency(stockInfo.fiftyTwoWeekLow) : 'N/A';
            renderSentimentSummaryUI(latestSentimentCounts, 0, true);

            const newsContainer = document.getElementById('newsArticles');
            newsContainer.innerHTML = '';

            if (articles.length === 0) {
                newsContainer.innerHTML = '<div style="color:#888;">No news articles available.</div>';
                renderSentimentSummaryUI(latestSentimentCounts, 0, false);
                setSentimentStatus('No articles to analyze.');
                return;
            }

            const pendingNotice = document.createElement('div');
            pendingNotice.className = 'news-pending';
            pendingNotice.textContent = 'Analyzing sentiment so we can highlight the most relevant articles...';
            newsContainer.appendChild(pendingNotice);

            progressivelyAnalyzeSentiment(
                articles,
                stockInfo.companyName || stockInfo.symbol,
                sentimentRunId,
                newsContainer,
                pendingNotice
            );
        }

        async function progressivelyAnalyzeSentiment(articles, companyName, runId, targetContainer, pendingElement) {
            if (!articles || !articles.length) {
                renderSentimentSummaryUI(latestSentimentCounts, 0, false);
                setSentimentStatus('No articles to analyze.');
                sentimentBatchSize = 0;
                updateSentimentProgress(0, false);
                return;
            }

            const newsContainer = targetContainer || document.getElementById('newsArticles');
            let waitingNotice = pendingElement || null;

            const total = articles.length;
            let completed = 0;
            sentimentBatchSize = total;
            updateSentimentProgress(0, true);
            setSentimentStatus(`Analyzing ${total} article${total === 1 ? '' : 's'}...`);
            const runIdentifier = String(runId);

            for (let idx = 0; idx < articles.length; idx++) {
                if (runId !== activeSentimentRunId) return;

                const article = articles[idx];
                let sentiment = null;
                let didTimeout = false;
                try {
                    sentiment = await fetchSentimentWithTimeout(
                        article,
                        companyName,
                        idx,
                        SENTIMENT_REQUEST_TIMEOUT_MS,
                        runIdentifier
                    );
                } catch (error) {
                    didTimeout = error.name === 'AbortError';
                    if (didTimeout) {
                        setSentimentStatus('Sentiment is taking longer than usual. Retrying...', 'error');
                        try {
                            sentiment = await fetchSentimentWithTimeout(
                                article,
                                companyName,
                                idx,
                                SENTIMENT_RETRY_TIMEOUT_MS,
                                runIdentifier
                            );
                            didTimeout = false;
                        } catch (retryError) {
                            didTimeout = retryError.name === 'AbortError';
                            console.error('Sentiment retry error:', retryError);
                        }
                    } else {
                        console.error('Sentiment analysis error:', error);
                    }
                }

                if (runId !== activeSentimentRunId) return;

                if (didTimeout && !sentiment) {
                    setSentimentStatus('Sentiment request timed out. Some articles may be missing sentiment.', 'error');
                }

                const normalized = (sentiment || '').toString().trim().toLowerCase();
                if (['positive', 'negative', 'neutral'].includes(normalized)) {
                    latestSentimentCounts[normalized] = (latestSentimentCounts[normalized] || 0) + 1;
                }

                if (waitingNotice && newsContainer && newsContainer.contains(waitingNotice)) {
                    newsContainer.removeChild(waitingNotice);
                    waitingNotice = null;
                }

                if (newsContainer && runId === activeSentimentRunId) {
                    const { badgeText, badgeClass } = determineSentimentBadge(normalized, didTimeout, Boolean(sentiment));
                    const articleElement = buildNewsArticleElement(
                        articles[idx],
                        badgeText,
                        badgeClass
                    );
                    newsContainer.appendChild(articleElement);
                }

                completed += 1;
                renderSentimentSummaryUI(latestSentimentCounts, completed, completed < total);
                setSentimentStatus(completed < total ? `Analyzed ${completed}/${total} articles...` : '');
            }
        }

        function determineSentimentBadge(normalizedSentiment, timedOut, hasRawValue) {
            if (['positive', 'negative', 'neutral'].includes(normalizedSentiment)) {
                return {
                    badgeText: normalizedSentiment,
                    badgeClass: `sentiment-badge ${normalizedSentiment}`
                };
            }

            if (timedOut) {
                return {
                    badgeText: 'Timeout',
                    badgeClass: 'sentiment-badge neutral muted'
                };
            }

            if (hasRawValue) {
                return {
                    badgeText: 'Unclear',
                    badgeClass: 'sentiment-badge neutral muted'
                };
            }

            return {
                badgeText: 'No result',
                badgeClass: 'sentiment-badge neutral muted'
            };
        }

        function buildNewsArticleElement(article, badgeText, badgeClass) {
            const articleDiv = document.createElement('div');
            articleDiv.className = 'news-article';

            if (article.link) {
                articleDiv.addEventListener('click', () => window.open(article.link, '_blank'));
            } else {
                articleDiv.style.cursor = 'default';
            }

            const publishedDate = article.publishedAt ? formatDate(article.publishedAt) : 'Recently updated';
            const sourceLabel = article.source ? `${article.source}  ${publishedDate}` : publishedDate;
            const description = article.description || 'No summary provided.';
            const actionCopy = article.link ? 'Click to read more' : 'Coverage updated recently';

            articleDiv.innerHTML = `
                <div class="news-source">${sourceLabel}</div>
                <div class="news-title">${article.title || 'Untitled coverage'}</div>
                <div class="news-description">${description}</div>
                <div class="news-meta">
                    <span>${actionCopy}</span>
                    <span class="${badgeClass}">${badgeText}</span>
                </div>
            `;

            return articleDiv;
        }

        function renderMovementInsight(insight) {
            if (!insight || !insight.summary) {
                movementBox.style.display = 'none';
                movementSummaryEl.textContent = '';
                movementMetaEl.textContent = '';
                movementSourcesEl.innerHTML = '';
                return;
            }

            movementBox.style.display = 'block';
            const changePercent = Number(insight.changePercent);
            movementMetaEl.textContent = Number.isFinite(changePercent)
                ? `Moved ${formatSignedPercentage(changePercent)} today`
                : 'Intraday move > 3%';
            movementSummaryEl.textContent = insight.summary;

            movementSourcesEl.innerHTML = '';
            const sources = Array.isArray(insight.sources) ? insight.sources : [];
            sources.forEach(source => {
                const li = document.createElement('li');
                const headline = source.headline || 'View source';
                const metaBits = [];
                if (source.source) metaBits.push(source.source);
                if (source.publishedAt) metaBits.push(formatDate(source.publishedAt));

                if (source.url) {
                    const link = document.createElement('a');
                    link.href = source.url;
                    link.target = '_blank';
                    link.rel = 'noopener noreferrer';
                    link.textContent = headline;
                    li.appendChild(link);
                } else {
                    li.textContent = headline;
                }

                if (metaBits.length) {
                    const metaSpan = document.createElement('span');
                    metaSpan.style.color = '#a1a1aa';
                    metaSpan.style.fontSize = '12px';
                    metaSpan.style.marginLeft = '6px';
                    metaSpan.textContent = ` ${metaBits.join('  ')}`;
                    li.appendChild(metaSpan);
                }

                movementSourcesEl.appendChild(li);
            });

            movementSourcesEl.style.display = movementSourcesEl.children.length ? 'flex' : 'none';
        }

        function createChart(data) {
            const ctx = document.getElementById('stockChart').getContext('2d');

            if (chart) {
                chart.destroy();
            }

            let chartData, labels;

            if (data && data.length > 0) {
                chartData = data.map(point => point.price);
                labels = data.map(point => '');
            } else {
                chartData = [];
                labels = [];
            }

            chart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        data: chartData,
                        borderColor: '#9333ea',
                        borderWidth: 2,
                        fill: false,
                        tension: 0.4,
                        pointRadius: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    layout: {
                        padding: {
                            left: 0,
                            right: 0,
                            top: 0,
                            bottom: 10
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            mode: 'index',
                            intersect: false,
                            callbacks: {
                                label: function(context) {
                                    return '$' + context.parsed.y.toFixed(2);
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            display: false
                        },
                        y: {
                            display: false,
                            grid: {
                                color: '#333',
                                drawBorder: false
                            },
                            ticks: {
                                color: '#888',
                                padding: 10,
                                callback: function(value) {
                                    return '$' + value.toFixed(0);
                                }
                            },
                            afterFit: (axis) => {
                                axis.width += 10;
                            }
                        }
                    },
                    interaction: {
                        mode: 'nearest',
                        axis: 'x',
                        intersect: false
                    }
                }
            });
        }

        document.addEventListener('DOMContentLoaded', function() {
            const tabs = document.querySelectorAll('.chart-tab');

            tabs.forEach(tab => {
                tab.addEventListener('click', async function() {
                    if (!currentSymbol) return;

                    tabs.forEach(t => t.classList.remove('active'));
                    this.classList.add('active');

                    const period = this.getAttribute('data-period');

                    if (historicalData[period]) {
                        createChart(historicalData[period]);
                    } else {
                        try {
                            const response = await fetch(`/historical/${currentSymbol}/${period}`);
                            const result = await response.json();

                            if (result.data) {
                                historicalData[period] = result.data;
                                createChart(result.data);
                            }
                        } catch (error) {
                            console.error('Error fetching historical data:', error);
                        }
                    }
                });
            });

            initializeTrendingTabs();
            const watchlistCount = renderWatchlist();
            initializeHomePanel(watchlistCount);

            if ((isHomePage || isWatchlistPage) && watchlistCount > 0) {
                refreshWatchlistPrices();
            }

            if (isMarketPage) {
                showWatchlistSection(false);
                showTrendingSection(false);
                loadMarketSummaryContent();
            } else if (isTrendingPage) {
                showTrendingSection(true);
                loadTrendingStocks();
                const canonicalPath = buildTrendingPath(currentTrendingSource);
                if (window.location.pathname !== canonicalPath) {
                    navigateToTrendingSource(currentTrendingSource, { replaceState: true });
                }
            } else {
                const shouldShowTrending = isHomePage && homePrimaryPanel === 'trending';
                showTrendingSection(shouldShowTrending);
            }

            if (isSearchPage && initialSearchQuery) {
                if (companyInputEl) {
                    companyInputEl.value = initialSearchQuery;
                }
                searchStock(initialSearchQuery);
            }

            if (watchlistToggleBtn) {
                watchlistToggleBtn.addEventListener('click', handleWatchlistToggleClick);
            }

            if (marketSummaryFormEl) {
                marketSummaryFormEl.addEventListener('submit', handleMarketSummarySignup);
            }
        });

        function formatDate(dateString) {
            const date = new Date(dateString);
            const now = new Date();
            const diff = Math.floor((now - date) / 1000 / 60 / 60);

            if (diff < 24) {
                return diff + 'h';
            } else {
                const days = Math.floor(diff / 24);
                return days + 'd';
            }
        }

        const companyInputEl = document.getElementById('companyInput');
        if (companyInputEl) {
            companyInputEl.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    searchStock();
                }
            });
        }

        async function loadTrendingSource(source, options = {}) {
            const {
                forceRefresh = false,
                includePrices = TRENDING_INCLUDE_PRICES
            } = options;
            const cached = getFreshTrendingCache(source, includePrices);
            if (!forceRefresh && cached) {
                renderTrendingData(source, cached.data);
                if (!cached.includePrices) {
                    hydrateTrendingPrices(source, cached.data);
                }
                return cached.data;
            }

            if (trendingFetchPromises[source]) {
                return trendingFetchPromises[source];
            }

            setTrendingListLoading(source);
            const fetchPromise = (async () => {
                try {
                    let url = `/trending/${source}`;
                    if (!includePrices) {
                        url += url.includes('?') ? '&' : '?';
                        url += 'include_prices=0';
                    }
                    const res = await fetch(url);
                    if (!res.ok) {
                        throw new Error(`Failed to load ${source} data.`);
                    }
                    const data = await res.json();
                    const items = data.data || [];
                    setTrendingCache(source, items, includePrices);
                    renderTrendingData(source, items);
                    if (!includePrices) {
                        hydrateTrendingPrices(source, items);
                    }
                    return items;
                } catch (e) {
                    console.error(`Trending ${source} error:`, e);
                    const fallback = trendingCache[source];
                    if (fallback && Array.isArray(fallback.data) && fallback.data.length) {
                        renderTrendingData(source, fallback.data);
                        if (!fallback.includePrices) {
                            hydrateTrendingPrices(source, fallback.data);
                        }
                    } else {
                        showTrendingMessage(source, 'Failed to load data.', true);
                    }
                    return null;
                } finally {
                    trendingFetchPromises[source] = null;
                }
            })();

            trendingFetchPromises[source] = fetchPromise;
            return fetchPromise;
        }

        function loadTrendingStocks(options = {}) {
            const mergedOptions = {
                includePrices: TRENDING_INCLUDE_PRICES,
                ...options
            };
            TRENDING_SOURCES.forEach(source => {
                loadTrendingSource(source, mergedOptions);
            });
        }

        function ensureHomeTrendingLoaded() {
            if (homeTrendingInitialized || isTrendingPage) return;
            loadTrendingStocks();
            homeTrendingInitialized = true;
        }

        async function loadMarketSummaryContent() {
            if (!marketSummarySectionEl) return;
            try {
                if (marketSummarySlug) {
                    let standaloneArticle = initialMarketSummaryArticle;
                    if (!standaloneArticle) {
                        const articlePayload = await fetchJson(`/api/market-summary/${encodeURIComponent(marketSummarySlug)}`);
                        standaloneArticle = articlePayload && articlePayload.article;
                    }
                    if (!standaloneArticle) {
                        throw new Error('Market summary article unavailable.');
                    }
                    const archivePayload = await fetchJson('/api/market-summary/archive?limit=10');
                    const archiveItems = (archivePayload && archivePayload.articles) || [];
                    renderMarketSummaryLatest(standaloneArticle);
                    renderMarketSummaryArchive(archiveItems, standaloneArticle.id);
                    return;
                }
                const [latestPayload, archivePayload] = await Promise.all([
                    fetchJson('/api/market-summary/latest'),
                    fetchJson('/api/market-summary/archive?limit=10')
                ]);
                const latestArticle = latestPayload && latestPayload.article;
                const archiveItems = (archivePayload && archivePayload.articles) || [];
                renderMarketSummaryLatest(latestArticle);
                renderMarketSummaryArchive(archiveItems, latestArticle && latestArticle.id);
            } catch (error) {
                console.error('Market summary load error:', error);
                if (marketSummaryLatestEl) {
                    marketSummaryLatestEl.innerHTML = `<div class="market-summary-empty error">${error.message || 'Unable to load market summary.'}</div>`;
                }
                if (marketSummaryArchiveEl) {
                    marketSummaryArchiveEl.innerHTML = '';
                }
            }
        }
        // Hide trending-section after a search, show on home
        function showTrendingSection(show) {
            const trendingSection = document.getElementById('trendingSection');
            if (!trendingSection) return;
            if (isTrendingPage) {
                trendingSection.style.display = '';
                return;
            }
            if (isWatchlistPage || isSearchPage || isMarketPage) {
                trendingSection.style.display = 'none';
                return;
            }
            if (show) {
                trendingSection.style.display = '';
                if (isHomePage) {
                    ensureHomeTrendingLoaded();
                }
            } else {
                trendingSection.style.display = 'none';
            }
        }
        function resetHomeView() {
            if (!isHomePage) {
                window.location.href = '/';
                return;
            }
            const inputEl = document.getElementById('companyInput');
            if (inputEl) inputEl.value = '';
            const resultsEl = document.getElementById('results');
            if (resultsEl) resultsEl.style.display = 'none';
            const errorEl = document.getElementById('errorMessage');
            if (errorEl) errorEl.innerHTML = '';
            const targetPanel = watchlistHasEntries ? 'watchlist' : 'trending';
            setHomePrimaryPanel(targetPanel);
        }

        function openTrendingPage() {
            navigateToTrendingSource('stocktwits');
        }

        if (homeTitleEl) {
            homeTitleEl.addEventListener('click', () => {
                if (!isHomePage) {
                    window.location.href = '/';
                    return;
                }
                resetHomeView();
            });
        }

        if (trendingBtnEl) {
            trendingBtnEl.addEventListener('click', () => {
                if (isTrendingPage) return;
                openTrendingPage();
            });
        }

        if (watchlistNavBtnEl) {
            watchlistNavBtnEl.addEventListener('click', () => {
                if (isWatchlistPage) {
                    if (watchlistSectionEl) {
                        watchlistSectionEl.style.display = '';
                    }
                    const count = renderWatchlist();
                    if (count > 0) {
                        refreshWatchlistPrices();
                    }
                } else {
                    window.location.href = '/watchlist';
                }
            });
        }

        if (marketSummaryBtnEl) {
            marketSummaryBtnEl.addEventListener('click', () => {
                if (isMarketPage && !marketSummarySlug) {
                    return;
                }
                window.location.href = '/market-summary';
            });
        }

        document.addEventListener('click', (event) => {
            if (!stocktwitsSummaryPopover || !stocktwitsSummaryPopover.classList.contains('visible')) {
                return;
            }
            if (stocktwitsSummaryPopover.contains(event.target)) {
                return;
            }
            if (event.target.closest && event.target.closest('.trending-info-btn')) {
                return;
            }
            hideStocktwitsPopover();
        }, true);

        document.addEventListener('keydown', (event) => {
            if (event.key === 'Escape') {
                hideStocktwitsPopover();
            }
        });

        window.addEventListener('scroll', () => {
            if (stocktwitsSummaryPopover && stocktwitsSummaryPopover.classList.contains('visible')) {
                hideStocktwitsPopover();
            }
        }, true);

        window.addEventListener('resize', () => {
            if (stocktwitsSummaryPopover && stocktwitsSummaryPopover.classList.contains('visible')) {
                hideStocktwitsPopover();
            }
        });

        if (isTrendingPage) {
            window.addEventListener('popstate', () => {
                const restoredSource = resolveTrendingSourceFromPath(window.location.pathname);
                setTrendingTabsActive(restoredSource);
            });
        }
    </script>
</body>
</html>